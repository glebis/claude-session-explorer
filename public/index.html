<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Session Explorer</title>
  <style>
    :root {
      --c-brand: #FF4D3B;
      --c-brand-dark: #E03E2E;
      --c-white: #FFFFFF;
      --c-ink: #111111;
      --c-ink-light: #555555;
      --c-meta: #999999;
      --c-bg-alt: #F7F7F7;
      --border-on-brand: rgba(0, 0, 0, 0.08);
      --border-on-white: #EAEAEA;
      --font-sans: "Helvetica Neue", Helvetica, Arial, sans-serif;
      --font-serif: Georgia, Times, serif;
      --space-xs: 8px;
      --space-sm: 16px;
      --space-md: 24px;
      --space-lg: 40px;
      --space-xl: 80px;
      /* Easing curves */
      --ease-out-quart: cubic-bezier(0.25, 1, 0.5, 1);
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--c-white);
      color: var(--c-ink);
      height: 100vh;
      display: flex;
      overflow: hidden;
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .layout { display: flex; width: 100%; height: 100%; }

    /* --- Left Panel (Brand) --- */
    .panel-brand {
      width: 40%;
      min-width: 360px;
      background: var(--c-brand);
      color: var(--c-ink);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-on-brand);
      overflow-y: auto;
    }

    .brand-header {
      padding: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--border-on-brand);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .logo {
      font-weight: 700;
      font-size: 20px;
      letter-spacing: -0.5px;
      text-transform: uppercase;
    }
    .logo span { font-weight: 400; opacity: 0.6; }

    /* Navigation */
    .nav-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-on-brand);
    }
    .nav-tab {
      flex: 1;
      padding: var(--space-sm);
      text-align: center;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--c-ink);
      opacity: 0.5;
      border-bottom: 2px solid transparent;
      font-family: var(--font-sans);
    }
    .nav-tab.active {
      opacity: 1;
      border-bottom-color: var(--c-ink);
    }
    .nav-tab:hover { opacity: 0.8; }

    /* Left panel content area */
    .panel-brand-content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
    .stat-cell {
      padding: var(--space-sm) var(--space-md);
      border-bottom: 1px solid var(--border-on-brand);
      border-right: 1px solid var(--border-on-brand);
    }
    .stat-cell:nth-child(2n) { border-right: none; }
    .stat-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.5;
      font-family: var(--font-serif);
      font-style: italic;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -1px;
      line-height: 1.2;
    }
    .stat-value.small { font-size: 18px; }

    /* Tool activity indicators */
    .tool-activity {
      padding: var(--space-sm) var(--space-md);
      border-bottom: 1px solid var(--border-on-brand);
    }
    .tool-activity-header {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.5;
      margin-bottom: var(--space-xs);
    }
    .tool-bar-row {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .tool-bar-label {
      width: 80px;
      flex-shrink: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .tool-bar-track {
      flex: 1;
      height: 8px;
      background: rgba(0,0,0,0.06);
      margin: 0 8px;
    }
    .tool-bar-fill {
      display: block;
      height: 100%;
      background: var(--c-ink);
      opacity: 0.3;
      transition: width 0.3s;
    }
    .tool-bar-count {
      width: 40px;
      text-align: right;
      font-size: 11px;
      opacity: 0.6;
    }

    /* Agent status area */
    .agent-status {
      padding: var(--space-sm) var(--space-md);
      border-bottom: 1px solid var(--border-on-brand);
      font-size: 12px;
      display: none;
    }
    .agent-status.active { display: block; }
    .agent-status .label {
      font-size: 10px;
      text-transform: uppercase;
      opacity: 0.5;
      margin-bottom: 4px;
    }
    .agent-tool-call {
      padding: 4px 0;
      opacity: 0.7;
      font-family: monospace;
      font-size: 11px;
    }

    /* Search panel */
    .search-panel {
      padding: var(--space-md);
    }
    .search-input-wrap {
      display: flex;
      gap: 8px;
      margin-bottom: var(--space-sm);
    }
    .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid rgba(0,0,0,0.1);
      background: rgba(255,255,255,0.85);
      font-size: 16px;
      font-family: var(--font-sans);
      color: var(--c-ink);
      outline: none;
      border-radius: 0;
      transition: border-color 250ms var(--ease-out-quart), background-color 250ms, box-shadow 250ms, transform 150ms;
    }
    .search-input::placeholder { color: rgba(0,0,0,0.35); }
    .search-input:focus {
      border-color: var(--c-ink);
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }
    .search-btn {
      padding: 12px 22px;
      background: var(--c-ink);
      color: var(--c-white);
      border: none;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      font-family: var(--font-sans);
      transition: background 200ms, transform 150ms;
    }
    .search-btn:hover { background: #333; transform: translateY(-1px); }
    .search-btn:active { transform: scale(0.97); }
    .search-btn:disabled { opacity: 0.4; cursor: default; transform: none; }

    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: var(--space-sm);
    }
    .filter-tag {
      padding: 3px 10px;
      font-size: 11px;
      border: 1px solid rgba(0,0,0,0.15);
      cursor: pointer;
      background: transparent;
      font-family: var(--font-sans);
    }
    .filter-tag.active { background: var(--c-ink); color: var(--c-brand); }

    /* Session meta panel */
    .session-meta-grid {
      padding: var(--space-md);
    }
    .meta-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border-on-brand);
      font-size: 13px;
    }
    .meta-row .key { opacity: 0.5; }

    /* Insights nav */
    .insights-nav {
      padding: var(--space-sm) 0;
    }
    .insights-nav-item {
      display: block;
      padding: var(--space-sm) var(--space-md);
      border-bottom: 1px solid var(--border-on-brand);
      cursor: pointer;
      font-size: 13px;
    }
    .insights-nav-item:hover { background: rgba(0,0,0,0.03); }
    .insights-nav-item span {
      display: block;
      font-size: 11px;
      opacity: 0.6;
      margin-top: 2px;
    }

    /* Brand footer */
    .brand-footer {
      padding: var(--space-sm) var(--space-md);
      border-top: 1px solid var(--border-on-brand);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      flex-shrink: 0;
    }

    /* --- Right Panel (Content) --- */
    .panel-content {
      width: 60%;
      background: var(--c-white);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .content-header {
      padding: var(--space-lg) var(--space-lg) var(--space-md);
      border-bottom: 1px solid var(--border-on-white);
    }
    .content-header .meta-label {
      font-size: 12px;
      color: var(--c-meta);
      margin-bottom: var(--space-sm);
      display: block;
      font-family: var(--font-serif);
      font-style: italic;
    }
    .content-header h1 {
      font-weight: 400;
      font-size: 28px;
      letter-spacing: -0.5px;
    }

    .content-body {
      flex: 1;
      padding: var(--space-md) var(--space-lg);
      overflow-y: auto;
    }

    /* Activity chart (CSS bars) */
    .activity-chart {
      margin-bottom: var(--space-lg);
    }
    .chart-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--c-meta);
      margin-bottom: var(--space-sm);
    }
    .chart-bars {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 120px;
      border-bottom: 1px solid var(--border-on-white);
      padding-bottom: 4px;
    }
    .chart-bar {
      flex: 1;
      background: var(--c-brand);
      min-width: 4px;
      cursor: pointer;
      position: relative;
      will-change: transform, opacity;
    }
    .chart-bar:hover { opacity: 0.8; }
    .chart-bar.dimmed { opacity: 0.25; }
    .chart-bar.selected {
      opacity: 1;
      transform: scaleX(1.4);
      z-index: 2;
      background: var(--c-ink);
      animation: bar-pulse 1.5s ease-in-out infinite;
    }
    @keyframes bar-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .chart-bar:hover::after, .chart-bar.selected::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--c-ink);
      color: var(--c-white);
      padding: 2px 6px;
      font-size: 10px;
      white-space: nowrap;
      pointer-events: none;
    }
    .chart-dates {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--c-meta);
      margin-top: 4px;
    }

    /* Date filter indicator */
    .date-filter-bar {
      display: none;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) 0;
      margin-bottom: var(--space-sm);
      font-size: 13px;
    }
    .date-filter-bar.visible { display: flex; }
    .date-filter-label {
      font-weight: 500;
    }
    .date-filter-clear {
      font-size: 11px;
      color: var(--c-meta);
      cursor: pointer;
      border: 1px solid var(--border-on-white);
      background: transparent;
      padding: 2px 8px;
      font-family: var(--font-sans);
    }
    .date-filter-clear:hover { background: var(--c-bg-alt); }

    /* Session list */
    .session-list {
      margin-bottom: var(--space-lg);
      contain: layout style;
    }
    .session-row {
      display: flex;
      align-items: baseline;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-on-white);
      cursor: pointer;
      text-decoration: none;
      color: var(--c-ink);
    }
    .session-row:has(.match-preview) {
      align-items: flex-start;
    }
    .session-row:hover { background: var(--c-bg-alt); }
    .session-time {
      width: 130px;
      flex-shrink: 0;
      font-size: 12px;
      color: var(--c-meta);
    }
    .session-summary {
      flex: 1;
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }
    .session-summary:has(.match-preview) {
      white-space: normal;
    }
    .session-project {
      font-size: 11px;
      color: var(--c-meta);
      margin-left: var(--space-sm);
      flex-shrink: 0;
    }
    .session-tokens {
      width: 80px;
      text-align: right;
      font-size: 11px;
      color: var(--c-meta);
      flex-shrink: 0;
    }

    /* Collapsed group */
    .session-group-row {
      display: flex;
      align-items: baseline;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-on-white);
      cursor: pointer;
      color: var(--c-ink);
    }
    .session-group-row:hover { background: var(--c-bg-alt); }
    .group-badge {
      display: inline-block;
      background: var(--c-ink);
      color: var(--c-white);
      font-size: 10px;
      padding: 1px 6px;
      margin-right: 6px;
      font-weight: 600;
      letter-spacing: 0.5px;
      vertical-align: 1px;
    }
    .group-expanded {
      border-left: 2px solid var(--border-on-white);
      margin-left: 130px;
      padding-left: var(--space-sm);
      margin-bottom: var(--space-xs);
    }
    .group-expanded .session-row {
      padding: 4px 0;
    }
    .group-expanded .session-time { width: auto; margin-right: var(--space-sm); }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-md) 0;
    }
    .pagination button {
      padding: 6px 16px;
      border: 1px solid var(--border-on-white);
      background: transparent;
      cursor: pointer;
      font-family: var(--font-sans);
      font-size: 12px;
    }
    .pagination button:hover { background: var(--c-bg-alt); }
    .pagination button:disabled { opacity: 0.3; cursor: default; }

    /* Agent response area */
    .agent-response {
      padding: var(--space-lg) var(--space-md);
      background: var(--c-bg-alt);
      border: 1px solid var(--border-on-white);
      margin-bottom: var(--space-md);
      font-size: 14px;
      line-height: 1.7;
      font-family: var(--font-serif);
      display: none;
    }
    .agent-response.visible { display: block; }
    .agent-response h1 { font-size: 22px; margin: var(--space-lg) 0 var(--space-sm); font-family: var(--font-sans); }
    .agent-response h2 { font-size: 17px; margin: var(--space-lg) 0 var(--space-sm); font-family: var(--font-sans); border-bottom: 1px solid var(--border-on-white); padding-bottom: 6px; }
    .agent-response h3 { font-size: 14px; margin: var(--space-md) 0 var(--space-xs); font-family: var(--font-sans); text-transform: uppercase; letter-spacing: 0.04em; color: var(--c-meta); }
    .agent-response h4 { font-size: 14px; margin: var(--space-sm) 0 var(--space-xs); font-family: var(--font-sans); }
    .agent-response p { margin: 0 0 var(--space-sm); }
    .agent-response code {
      background: rgba(0,0,0,0.06);
      padding: 1px 4px;
      font-size: 13px;
    }
    .agent-response pre {
      background: var(--c-ink);
      color: var(--c-white);
      padding: var(--space-sm);
      overflow-x: auto;
      margin: var(--space-sm) 0;
      font-size: 12px;
    }
    .agent-response ul, .agent-response ol {
      margin: 0 0 var(--space-sm);
      padding-left: 1.5em;
    }
    .agent-response li { margin-bottom: 4px; }

    /* Tables */
    .agent-response table {
      width: 100%;
      border-collapse: collapse;
      margin: var(--space-sm) 0 var(--space-md);
      font-size: 13px;
      font-family: var(--font-sans);
    }
    .agent-response th {
      text-align: left;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--c-meta);
      padding: 8px 12px;
      border-bottom: 2px solid var(--c-ink);
    }
    .agent-response td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-on-white);
      vertical-align: top;
    }
    .agent-response tr:last-child td { border-bottom: none; }
    .agent-response tr:hover td { background: rgba(0,0,0,0.02); }

    /* Actionable suggestion cards in session detail */
    .suggestion-card {
      background: var(--c-white);
      border: 1px solid var(--border-on-white);
      border-left: 3px solid var(--c-brand);
      padding: var(--space-sm) var(--space-md);
      margin: var(--space-sm) 0;
      cursor: pointer;
      transition: background 200ms, box-shadow 200ms;
    }
    .suggestion-card:hover {
      background: #fafafa;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .suggestion-card .suggestion-title {
      font-family: var(--font-sans);
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .suggestion-card .suggestion-desc {
      font-size: 12px;
      color: var(--c-meta);
      line-height: 1.5;
    }
    .suggestion-card .suggestion-prompt {
      font-size: 12px;
      font-family: monospace;
      background: rgba(0,0,0,0.04);
      padding: 6px 10px;
      margin-top: 8px;
      border-radius: 3px;
      cursor: copy;
      position: relative;
    }
    .suggestion-card .suggestion-prompt::after {
      content: 'Click to copy';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: var(--c-meta);
      font-family: var(--font-sans);
    }
    .suggestion-card .suggestion-prompt.copied::after {
      content: 'Copied!';
      color: var(--c-brand);
    }

    /* Copyable prompts in agent responses */
    .agent-response .copyable-prompt {
      background: rgba(0,0,0,0.04);
      padding: 4px 8px;
      border-radius: 3px;
      border: 1px dashed rgba(0,0,0,0.1);
      transition: background 200ms, border-color 200ms;
      display: inline-block;
      margin: 2px 0;
    }
    .agent-response .copyable-prompt:hover {
      background: rgba(0,0,0,0.08);
      border-color: var(--c-brand);
    }

    /* Session download/view links */
    .session-actions {
      display: flex;
      gap: 12px;
      margin: var(--space-md) 0;
      padding: var(--space-sm) 0;
      border-top: 1px solid var(--border-on-white);
    }
    .session-action-link {
      font-size: 12px;
      font-family: var(--font-sans);
      color: var(--c-brand);
      text-decoration: none;
      cursor: pointer;
      padding: 4px 0;
      border: none;
      background: none;
      transition: opacity 200ms;
    }
    .session-action-link:hover { opacity: 0.7; }

    /* Session detail view */
    .session-detail { display: none; }
    .session-detail.visible { display: block; animation: detailEnter 300ms var(--ease-out-quart); }
    @keyframes detailEnter {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .detail-section {
      margin-bottom: var(--space-lg);
    }
    .section-header {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--c-meta);
      margin-bottom: var(--space-sm);
    }

    .message-timeline {
      border-left: 2px solid var(--border-on-white);
      padding-left: var(--space-md);
    }
    .timeline-entry {
      margin-bottom: var(--space-md);
      position: relative;
    }
    .timeline-entry::before {
      content: '';
      position: absolute;
      left: calc(-1 * var(--space-md) - 5px);
      top: 4px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border-on-white);
    }
    .timeline-entry.user::before { background: var(--c-brand); }
    .timeline-entry.assistant::before { background: var(--c-ink); }
    .timeline-role {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--c-meta);
      margin-bottom: 2px;
    }
    .timeline-content {
      font-size: 13px;
      line-height: 1.5;
    }
    .timeline-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .tool-badge {
      font-size: 10px;
      padding: 1px 6px;
      background: var(--c-bg-alt);
      border: 1px solid var(--border-on-white);
    }

    /* Insights view */
    .insights-content {
      font-family: var(--font-serif);
      font-size: 15px;
      line-height: 1.7;
    }
    .insights-content h2, .insights-content h3, .insights-content h4 {
      font-family: var(--font-sans);
      font-weight: 500;
      margin: var(--space-md) 0 var(--space-sm);
    }

    /* Report list (accumulated insights) */
    .report-list { display: flex; flex-direction: column; gap: var(--space-sm); margin-top: var(--space-sm); }
    .report-list-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-xs); }
    .report-list-header h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--c-meta); font-weight: 500; }
    .report-clear-btn { font-size: 11px; color: var(--c-meta); background: none; border: none; cursor: pointer; font-family: var(--font-sans); }
    .report-clear-btn:hover { color: var(--c-brand); }

    .report-card {
      border: 1px solid var(--border-on-white);
      background: var(--c-white);
      transition: box-shadow 0.15s ease;
    }
    .report-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .report-card-header {
      display: flex; align-items: center; gap: var(--space-xs);
      padding: 10px var(--space-sm);
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid transparent;
    }
    .report-card.expanded .report-card-header { border-bottom-color: var(--border-on-white); }
    .report-card-toggle {
      font-size: 10px; color: var(--c-meta);
      transition: transform 0.15s ease;
      flex-shrink: 0; width: 16px; text-align: center;
    }
    .report-card.expanded .report-card-toggle { transform: rotate(90deg); }
    .report-card-title { font-size: 13px; font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .report-card-time { font-size: 10px; color: var(--c-meta); flex-shrink: 0; }
    .report-card-body {
      display: none;
      padding: var(--space-sm);
      max-height: 500px;
      overflow-y: auto;
    }
    .report-card.expanded .report-card-body { display: block; }
    .report-card-actions {
      display: flex; gap: 6px; padding: 6px var(--space-sm);
      border-top: 1px solid var(--border-on-white);
    }
    .report-card .report-card-actions { display: none; }
    .report-card.expanded .report-card-actions { display: flex; }
    .report-action-btn {
      font-size: 10px; color: var(--c-meta); background: none; border: 1px solid var(--border-on-white);
      padding: 2px 8px; cursor: pointer; font-family: var(--font-sans);
      transition: all 150ms;
    }
    .report-action-btn:hover { color: var(--c-ink); border-color: var(--c-ink); }
    .report-delete-btn:hover { color: var(--c-brand); border-color: var(--c-brand); }

    /* Flashcard review mode */
    .flashcard-overlay {
      position: fixed; inset: 0; z-index: 2000;
      background: rgba(0,0,0,0.55); backdrop-filter: blur(6px);
      display: none; align-items: center; justify-content: center;
      padding: 24px;
    }
    .flashcard-overlay.visible { display: flex; }
    .flashcard {
      width: 540px; max-width: 92vw; max-height: 72vh;
      background: var(--c-white); box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      display: flex; flex-direction: column;
      animation: cardIn 250ms var(--ease-out-quart);
      overflow: hidden; position: relative;
    }
    @keyframes cardIn {
      from { opacity: 0; transform: scale(0.95) translateY(12px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .flashcard-header {
      padding: 10px 16px; border-bottom: 1px solid var(--border-on-white);
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; min-height: 0;
    }
    .flashcard-header-left { display: flex; align-items: center; gap: 10px; min-width: 0; flex: 1; }
    .flashcard-counter {
      font-size: 10px; color: var(--c-white); background: var(--c-brand);
      padding: 2px 7px; letter-spacing: 0.3px; white-space: nowrap; flex-shrink: 0;
    }
    .flashcard-title {
      font-size: 13px; font-weight: 600; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis; min-width: 0;
    }
    .flashcard-close {
      background: none; border: none; font-size: 18px; cursor: pointer;
      color: var(--c-meta); line-height: 1; padding: 2px 4px; flex-shrink: 0;
      transition: color 150ms;
    }
    .flashcard-close:hover { color: var(--c-ink); }
    /* Progress bar below header */
    .flashcard-progress {
      height: 2px; background: var(--border-on-white);
    }
    .flashcard-progress-fill {
      height: 100%; background: var(--c-brand);
      transition: width 300ms var(--ease-out-quart);
    }
    /* Slide container */
    .flashcard-slide-wrap {
      flex: 1; overflow: hidden; position: relative; min-height: 200px;
    }
    .flashcard-body {
      position: absolute; inset: 0; overflow-y: auto; padding: 14px 16px;
      font-size: 13px; line-height: 1.65;
      transition: transform 250ms var(--ease-out-quart), opacity 200ms ease;
    }
    .flashcard-body.slide-out-left  { transform: translateX(-100%); opacity: 0; }
    .flashcard-body.slide-out-right { transform: translateX(100%); opacity: 0; }
    .flashcard-body.slide-in-left   { animation: slideInLeft 250ms var(--ease-out-quart) forwards; }
    .flashcard-body.slide-in-right  { animation: slideInRight 250ms var(--ease-out-quart) forwards; }
    @keyframes slideInLeft {
      from { transform: translateX(100%); opacity: 0; }
      to   { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideInRight {
      from { transform: translateX(-100%); opacity: 0; }
      to   { transform: translateX(0); opacity: 1; }
    }
    .flashcard-nav {
      padding: 8px 16px; border-top: 1px solid var(--border-on-white);
      display: flex; align-items: center; justify-content: space-between;
    }
    .flashcard-nav-btn {
      padding: 5px 14px; background: var(--c-ink); color: var(--c-white);
      border: none; font-size: 11px; text-transform: uppercase; letter-spacing: 0.4px;
      cursor: pointer; font-family: var(--font-sans); transition: all 150ms;
    }
    .flashcard-nav-btn:hover { opacity: 0.85; transform: translateY(-1px); }
    .flashcard-nav-btn:active { transform: translateY(0); }
    .flashcard-nav-btn:disabled { opacity: 0.25; cursor: default; transform: none; }
    .flashcard-nav-center {
      display: flex; align-items: center; gap: 4px;
    }
    .flashcard-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--border-on-white); transition: all 250ms;
    }
    .flashcard-dot.active { background: var(--c-brand); transform: scale(1.3); }

    /* Report index in left panel */
    .report-index { margin-top: var(--space-sm); border-top: 1px solid var(--border-on-brand); padding: var(--space-sm) var(--space-md) 0; }
    .report-index-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.5; margin-bottom: 6px; }
    .report-index-item {
      display: block; width: 100%;
      text-align: left; background: none; border: none;
      font-family: var(--font-sans); font-size: 12px;
      padding: 4px 0; cursor: pointer; color: var(--c-ink);
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      opacity: 0.7;
    }
    .report-index-item:hover { opacity: 1; }

    /* Action cards */
    .action-cards {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    .action-card {
      border: 1px solid var(--border-on-white);
      padding: var(--space-sm) var(--space-md);
    }
    .action-card-header {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      margin-bottom: var(--space-xs);
    }
    .action-category {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 8px;
      font-weight: 600;
    }
    .action-category.hook { background: #E8F5E9; color: #2E7D32; }
    .action-category.claude-md { background: #E3F2FD; color: #1565C0; }
    .action-category.automation { background: #FFF3E0; color: #E65100; }
    .action-category.workflow { background: #F3E5F5; color: #7B1FA2; }
    .action-effort {
      font-size: 10px;
      color: var(--c-meta);
      margin-left: auto;
    }
    .action-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .action-observation {
      font-size: 12px;
      color: var(--c-ink-light);
      margin-bottom: var(--space-xs);
      font-style: italic;
      font-family: var(--font-serif);
    }
    .action-description {
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: var(--space-sm);
    }
    .action-artifact {
      background: var(--c-ink);
      color: #ddd;
      padding: var(--space-sm);
      font-family: monospace;
      font-size: 12px;
      line-height: 1.4;
      overflow-x: auto;
      white-space: pre;
      margin-bottom: var(--space-xs);
      position: relative;
    }
    .action-artifact-path {
      font-size: 11px;
      color: var(--c-meta);
      margin-bottom: 4px;
      font-family: monospace;
    }
    .action-buttons {
      display: flex;
      gap: var(--space-xs);
      margin-top: var(--space-xs);
    }
    .action-btn {
      padding: 4px 14px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid var(--border-on-white);
      background: transparent;
      cursor: pointer;
      font-family: var(--font-sans);
    }
    .action-btn:hover { background: var(--c-bg-alt); }
    .action-btn.primary {
      background: var(--c-ink);
      color: var(--c-white);
      border-color: var(--c-ink);
    }
    .action-btn.primary:hover { opacity: 0.9; }
    .action-btn:disabled { opacity: 0.4; cursor: default; }
    .action-applied {
      font-size: 11px;
      color: #2E7D32;
      padding: 4px 0;
    }

    /* Generate actions button */
    .generate-actions-btn {
      display: block;
      width: 100%;
      padding: var(--space-sm);
      background: var(--c-ink);
      color: var(--c-white);
      border: none;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      font-family: var(--font-sans);
      margin-bottom: var(--space-md);
    }
    .generate-actions-btn:hover { opacity: 0.9; }
    .generate-actions-btn:disabled { opacity: 0.4; cursor: default; }

    /* Time group headers */
    .time-group-header {
      font-size: 13px;
      font-weight: 600;
      padding: var(--space-sm) 0 var(--space-xs);
      margin-top: var(--space-sm);
      border-bottom: 2px solid var(--c-ink);
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }
    .time-group-header:first-child { margin-top: 0; }
    .time-group-header .count {
      font-size: 11px;
      font-weight: 400;
      color: var(--c-meta);
    }

    /* Granularity toggle */
    .granularity-toggle {
      display: flex;
      gap: 2px;
      margin-left: auto;
    }
    .granularity-btn {
      padding: 3px 10px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid var(--border-on-white);
      background: transparent;
      cursor: pointer;
      font-family: var(--font-sans);
      color: var(--c-meta);
    }
    .granularity-btn.active {
      background: var(--c-ink);
      color: var(--c-white);
      border-color: var(--c-ink);
    }

    /* Inline find session */
    .find-session-bar {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      margin-bottom: var(--space-sm);
    }
    .find-session-input {
      flex: 1;
      padding: 10px 14px;
      border: 1.5px solid var(--border-on-white);
      font-size: 15px;
      font-family: var(--font-sans);
      transition: border-color 250ms var(--ease-out-quart), background-color 250ms, box-shadow 250ms, transform 150ms;
      outline: none;
      background: var(--c-bg-alt);
    }
    .find-session-input:focus { border-color: var(--c-ink); background: var(--c-white); }
    .find-session-input::placeholder { color: var(--c-meta); }

    /* Transcript viewer */
    .transcript {
      font-family: var(--font-sans);
      font-size: 13px;
      line-height: 1.6;
    }
    .transcript-msg {
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-on-white);
    }
    .transcript-msg:last-child { border-bottom: none; }
    .transcript-role {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .transcript-role.user { color: var(--c-brand); }
    .transcript-role.assistant { color: var(--c-ink); }
    .transcript-text {
      white-space: pre-wrap;
      word-break: break-word;
    }
    .transcript-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .transcript-tool {
      font-size: 10px;
      padding: 1px 6px;
      background: var(--c-bg-alt);
      border: 1px solid var(--border-on-white);
    }
    .transcript-tool.error { border-color: var(--c-brand); color: var(--c-brand); }
    .transcript-time {
      font-size: 10px;
      color: var(--c-meta);
      float: right;
    }

    /* Session action links */
    .session-actions {
      display: flex;
      gap: var(--space-xs);
      margin-bottom: var(--space-sm);
    }
    .session-action-link {
      padding: 4px 12px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid var(--border-on-white);
      background: transparent;
      cursor: pointer;
      font-family: var(--font-sans);
    }
    .session-action-link:hover { background: var(--c-bg-alt); }
    .session-action-link.active {
      background: var(--c-ink);
      color: var(--c-white);
      border-color: var(--c-ink);
    }
    .session-action-btn {
      background: var(--c-brand);
      color: var(--c-white);
      border-color: var(--c-brand);
    }
    .session-action-btn:hover { background: var(--c-brand-dark); }
    .session-action-btn:disabled { opacity: 0.6; cursor: wait; }

    /* Smart filter chips */
    .smart-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: var(--space-sm);
    }
    .smart-filter {
      padding: 3px 10px;
      font-size: 11px;
      border: 1px solid var(--border-on-white);
      background: transparent;
      cursor: pointer;
      font-family: var(--font-sans);
      color: var(--c-ink-light);
      white-space: nowrap;
    }
    .smart-filter:hover { background: var(--c-bg-alt); }
    .smart-filter.active {
      background: var(--c-ink);
      color: var(--c-white);
      border-color: var(--c-ink);
    }
    .smart-filter .filter-count {
      font-size: 9px;
      opacity: 0.6;
      margin-left: 3px;
    }

    /* Search match preview */
    .match-preview {
      display: block;
      font-size: 11px;
      color: var(--c-meta);
      line-height: 1.4;
      margin-top: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .match-preview mark {
      background: rgba(255, 77, 59, 0.2);
      color: var(--c-ink);
      padding: 0 1px;
      font-weight: 500;
    }
    .match-source {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.5;
      margin-right: 4px;
    }

    /* Loading spinner */
    .loading {
      display: none;
      padding: var(--space-md);
      color: var(--c-meta);
      font-style: italic;
    }
    .loading.visible { display: block; }
    .loading::after {
      content: '';
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid var(--c-meta);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Hide/show views */
    .view { display: none; }
    .view.active { display: block; }

    /* Back button */
    .back-btn {
      display: inline-block;
      padding: 4px 12px;
      font-size: 12px;
      border: 1px solid var(--border-on-white);
      background: transparent;
      cursor: pointer;
      font-family: var(--font-sans);
      flex-shrink: 0;
      margin-top: 4px;
    }
    .back-btn:hover { background: var(--c-bg-alt); }

    /* Cost display */
    .cost-display {
      font-size: 11px;
      color: var(--c-meta);
      margin-top: var(--space-xs);
      padding-top: var(--space-xs);
      border-top: 1px solid var(--border-on-white);
    }

    /* SVG Sparklines */
    .stat-sparkline {
      display: block;
      margin-top: 4px;
      opacity: 0.4;
    }
    .stat-sparkline polyline {
      fill: none;
      stroke: var(--c-ink);
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* Collapsible sections */
    .collapsible-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .collapsible-header::before {
      content: '\25B6'; /* right triangle */
      font-size: 8px;
      color: var(--c-meta);
      transition: transform 200ms var(--ease-out-quart);
      flex-shrink: 0;
    }
    .collapsible-header.expanded::before { transform: rotate(90deg); }
    .collapsible-body {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 400ms var(--ease-out-quart), opacity 300ms, margin 200ms;
      margin-top: 0;
    }
    .collapsible-body.expanded {
      max-height: 2000px;
      opacity: 1;
      margin-top: var(--space-sm);
    }

    /* Calendar Module */
    .calendar-section {
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-on-white);
    }
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-sm);
    }
    .calendar-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--c-meta);
    }
    .calendar-modes {
      display: flex;
      gap: 2px;
    }
    .calendar-mode-btn {
      padding: 3px 8px;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid var(--border-on-white);
      background: transparent;
      cursor: pointer;
      font-family: var(--font-sans);
      color: var(--c-meta);
      transition: background 150ms, color 150ms;
    }
    .calendar-mode-btn.active {
      background: var(--c-ink);
      color: var(--c-white);
      border-color: var(--c-ink);
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: 24px repeat(7, 1fr);
      gap: 1px;
    }
    .calendar-weekday {
      font-size: 8px;
      color: var(--c-meta);
      text-align: center;
      padding-bottom: 2px;
    }
    .calendar-week-label {
      font-size: 8px;
      color: var(--c-meta);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 4px;
    }
    .calendar-day {
      aspect-ratio: 1;
      min-height: 14px;
      border-radius: 2px;
      position: relative;
      cursor: pointer;
      transition: transform 100ms var(--ease-out-quart), box-shadow 150ms;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calendar-day:hover {
      transform: scale(1.2);
      z-index: 3;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .calendar-day:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--c-ink);
      color: var(--c-white);
      padding: 4px 8px;
      font-size: 10px;
      white-space: pre;
      pointer-events: none;
      z-index: 10;
      border-radius: 2px;
      line-height: 1.4;
    }
    .calendar-day.empty {
      background: transparent;
      cursor: default;
    }
    .calendar-day.empty:hover {
      transform: none;
      box-shadow: none;
    }
    .calendar-day.today {
      outline: 2px solid var(--c-ink);
      outline-offset: -1px;
    }
    .calendar-day .day-number {
      font-size: 7px;
      color: rgba(0,0,0,0.3);
      position: absolute;
      top: 1px;
      right: 2px;
      pointer-events: none;
    }
    .calendar-day .day-value {
      font-size: 9px;
      font-weight: 600;
      color: rgba(0,0,0,0.55);
      pointer-events: none;
      line-height: 1;
      transition: font-size 200ms;
    }
    .calendar-day.empty .day-value { display: none; }
    .calendar-day.danger .day-number {
      color: #C62828;
      font-weight: 700;
    }
    .calendar-day.danger::before {
      content: '';
      position: absolute;
      top: 1px;
      left: 1px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #C62828;
      z-index: 1;
    }
    .calendar-day.late-night::before {
      content: '';
      position: absolute;
      bottom: 1px;
      right: 1px;
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: #7B1FA2;
      z-index: 1;
    }
    .calendar-legend {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-top: var(--space-xs);
      font-size: 9px;
      color: var(--c-meta);
      flex-wrap: wrap;
    }
    .calendar-legend-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .calendar-legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }
    .calendar-month-row {
      grid-column: 1 / -1;
      font-size: 11px;
      font-weight: 600;
      padding: var(--space-xs) 0 2px;
      color: var(--c-ink-light);
    }
    .calendar-month-row:first-child { padding-top: 0; }

    /* Calendar filters row */
    .calendar-filters {
      display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: var(--space-xs);
    }
    .calendar-filter-btn {
      padding: 2px 8px; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;
      border: 1px solid var(--border-on-white); background: transparent;
      cursor: pointer; font-family: var(--font-sans); color: var(--c-meta);
      transition: all 150ms; display: flex; align-items: center; gap: 3px;
    }
    .calendar-filter-btn .filter-icon { font-size: 10px; }
    .calendar-filter-btn.active { border-color: var(--c-ink); color: var(--c-ink); font-weight: 600; }
    .calendar-filter-btn.active.health { border-color: #C62828; color: #C62828; }
    .calendar-filter-btn.active.night  { border-color: #7B1FA2; color: #7B1FA2; }
    .calendar-filter-btn.active.streak { border-color: #1565C0; color: #1565C0; }
    .calendar-filter-btn.active.trend  { border-color: #2E7D32; color: #2E7D32; }

    /* Filtered calendar cell overlays */
    .calendar-day.filter-dim { opacity: 0.15; }
    .calendar-day.filter-highlight { outline: 2px solid currentColor; outline-offset: -1px; z-index: 2; }
    .calendar-day .day-trend {
      position: absolute; bottom: 1px; left: 2px; font-size: 8px; font-weight: 700;
      pointer-events: none; line-height: 1;
    }
    .day-trend.up { color: #C62828; }
    .day-trend.down { color: #2E7D32; }
    .day-trend.flat { color: var(--c-meta); }

    /* Trends summary strip */
    .calendar-trends {
      display: flex; flex-wrap: wrap; gap: 6px; margin-top: var(--space-xs);
      font-size: 10px; color: var(--c-ink-light);
    }
    .trend-chip {
      padding: 3px 8px; background: var(--c-beige); border-radius: 2px;
      display: flex; align-items: center; gap: 4px;
    }
    .trend-chip .trend-label { color: var(--c-meta); }
    .trend-chip .trend-value { font-weight: 600; }
    .trend-chip .trend-arrow { font-size: 11px; }
    .trend-chip .trend-arrow.up   { color: #C62828; }
    .trend-chip .trend-arrow.down { color: #2E7D32; }

    /* Export button */
    .calendar-export-btn {
      padding: 2px 6px; font-size: 9px; border: 1px solid var(--border-on-white);
      background: transparent; cursor: pointer; font-family: var(--font-sans);
      color: var(--c-meta); transition: all 150ms; margin-left: 4px;
    }
    .calendar-export-btn:hover { border-color: var(--c-ink); color: var(--c-ink); }

    /* Wellbeing strip */
    .wellbeing-strip {
      display: flex;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      border-bottom: 1px solid var(--border-on-brand);
      flex-wrap: wrap;
    }
    .wellbeing-metric {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .wellbeing-metric .wb-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.4;
    }
    .wellbeing-metric .wb-value {
      font-weight: 600;
      font-size: 14px;
    }
    .wellbeing-metric .wb-value.warn { color: #E65100; }
    .wellbeing-metric .wb-value.danger { color: #C62828; }
    .wellbeing-metric .wb-value.good { color: #2E7D32; }

    /* Project swimlane timeline */
    .swimlane-section {
      margin-bottom: var(--space-sm);
      border: 1px solid var(--border-on-white);
      padding: var(--space-xs) var(--space-sm);
    }
    .swimlane-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--c-meta);
      margin-bottom: var(--space-xs);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .swimlane-toggle {
      font-size: 10px;
      color: var(--c-meta);
      border: 1px solid var(--border-on-white);
      background: transparent;
      padding: 2px 8px;
      cursor: pointer;
      font-family: var(--font-sans);
    }
    .swimlane-grid {
      display: grid;
      gap: 1px;
      font-size: 10px;
    }
    .swimlane-row {
      display: contents;
    }
    .swimlane-label {
      font-size: 10px;
      color: var(--c-ink-light);
      padding: 2px 6px 2px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100px;
    }
    .swimlane-cell {
      min-height: 12px;
      background: var(--c-bg-alt);
      cursor: pointer;
      position: relative;
      transition: opacity 150ms;
    }
    .swimlane-cell.active {
      background: var(--c-brand);
      opacity: 0.7;
    }
    .swimlane-cell:hover { opacity: 0.8; }
    .swimlane-cell:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 2px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--c-ink);
      color: var(--c-white);
      padding: 2px 6px;
      font-size: 9px;
      white-space: nowrap;
      z-index: 5;
      pointer-events: none;
    }
    .swimlane-dates {
      display: contents;
    }
    .swimlane-date-label {
      font-size: 8px;
      color: var(--c-meta);
      text-align: center;
    }

    /* Stat trend indicators */
    .stat-trend {
      font-size: 10px;
      margin-top: 2px;
      font-weight: 400;
    }
    .stat-trend.up { color: #2E7D32; }
    .stat-trend.down { color: #C62828; }
    .stat-trend.flat { color: var(--c-meta); }

    /* Heatmap */
    .heatmap-section {
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-on-white);
    }
    .heatmap-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--c-meta);
      margin-bottom: var(--space-xs);
    }
    .heatmap-grid {
      display: grid;
      grid-template-columns: 32px repeat(24, 1fr);
      gap: 1px;
      font-size: 9px;
    }
    .heatmap-row-label {
      font-size: 9px;
      color: var(--c-meta);
      display: flex;
      align-items: center;
      padding-right: 4px;
    }
    .heatmap-col-labels {
      display: contents;
    }
    .heatmap-col-label {
      text-align: center;
      font-size: 8px;
      color: var(--c-meta);
      padding-bottom: 2px;
    }
    .heatmap-cell {
      aspect-ratio: 1;
      min-height: 10px;
      background: var(--c-brand);
      opacity: 0.05;
      cursor: pointer;
      position: relative;
      transition: opacity 150ms, transform 100ms;
    }
    .heatmap-cell:hover {
      transform: scale(1.3);
      z-index: 2;
    }
    .heatmap-cell:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--c-ink);
      color: var(--c-white);
      padding: 2px 6px;
      font-size: 9px;
      white-space: nowrap;
      pointer-events: none;
      z-index: 10;
    }

    /* Error rate indicator */
    .error-rate-section {
      padding: var(--space-sm) var(--space-md);
      border-bottom: 1px solid var(--border-on-brand);
    }
    .error-rate-header {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.5;
      margin-bottom: var(--space-xs);
    }
    .error-rate-value {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    .error-rate-value.low { color: #2E7D32; }
    .error-rate-value.medium { color: #E65100; }
    .error-rate-value.high { color: #C62828; }
    .error-categories {
      margin-top: 4px;
    }

    /* Session row badges */
    .session-badges {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      margin-left: 8px;
    }
    .badge {
      font-size: 9px;
      padding: 1px 4px;
      border: 1px solid;
      white-space: nowrap;
      line-height: 1.3;
    }
    .badge-error {
      color: #C62828;
      border-color: #C62828;
      background: rgba(198, 40, 40, 0.08);
    }
    .badge-lang {
      color: var(--c-ink-light);
      border-color: var(--border-on-white);
      background: var(--c-bg-alt);
    }
    .badge-task {
      color: #1565C0;
      border-color: #1565C0;
      background: rgba(21, 101, 192, 0.08);
    }
    .badge-cost {
      color: var(--c-meta);
      border: none;
      padding: 0;
      font-family: var(--font-sans);
    }
    .badge-lines {
      color: #2E7D32;
      border: none;
      padding: 0;
    }
    .badge-lines.negative { color: #C62828; }

    /* Quick insights strip */
    .insights-strip {
      padding: var(--space-xs) var(--space-md);
      border-bottom: 1px solid var(--border-on-brand);
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .insight-chip {
      font-size: 10px;
      padding: 3px 8px;
      background: rgba(0,0,0,0.06);
      border: none;
      cursor: default;
      font-family: var(--font-sans);
      line-height: 1.4;
      max-width: 100%;
    }
    .insight-chip button {
      font-size: 9px;
      padding: 1px 6px;
      margin-left: 4px;
      background: var(--c-ink);
      color: var(--c-brand);
      border: none;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: var(--font-sans);
    }
    .insight-chip button:hover { opacity: 0.8; }

    /* Quick action buttons */
    .quick-actions {
      display: flex;
      gap: 6px;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-on-white);
    }
    .quick-action-btn {
      padding: 5px 12px;
      font-size: 11px;
      border: 1px solid var(--border-on-white);
      background: transparent;
      cursor: pointer;
      font-family: var(--font-sans);
      color: var(--c-ink-light);
      transition: background 150ms, color 150ms;
    }
    .quick-action-btn:hover {
      background: var(--c-ink);
      color: var(--c-white);
    }

    /* ========================================
       VOICE FAB & OVERLAY
       ======================================== */

    /* Voice FAB - compact minimalist design */
    .voice-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--c-ink);
      color: var(--c-white);
      border: none;
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      transition: all 200ms var(--ease-out-quart);
    }
    .voice-fab:hover { transform: scale(1.08); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
    .voice-fab:active { transform: scale(0.95); }
    .voice-fab svg { width: 18px; height: 18px; fill: currentColor; }

    /* Idle state: no animation, quiet */
    .voice-fab.idle { opacity: 0.7; }
    .voice-fab.idle:hover { opacity: 1; }

    /* Listening: brand color + ring pulse */
    .voice-fab.listening {
      background: var(--c-brand);
      opacity: 1;
      animation: voiceRing 1.2s ease-out infinite;
    }
    @keyframes voiceRing {
      0% { box-shadow: 0 2px 12px rgba(0,0,0,0.15), 0 0 0 0 rgba(255,77,59,0.4); }
      70% { box-shadow: 0 2px 12px rgba(0,0,0,0.15), 0 0 0 14px rgba(255,77,59,0); }
      100% { box-shadow: 0 2px 12px rgba(0,0,0,0.15), 0 0 0 0 rgba(255,77,59,0); }
    }

    /* Processing: muted + spin */
    .voice-fab.processing {
      background: var(--c-ink-light);
      opacity: 1;
    }
    .voice-fab.processing svg { animation: spin 0.8s linear infinite; }

    /* Stopped (finished listening, waiting for re-click) */
    .voice-fab.stopped {
      background: var(--c-ink);
      opacity: 0.9;
    }

    /* Compact voice tooltip (replaces large overlay) */
    .voice-tooltip {
      position: fixed;
      bottom: 76px;
      right: 24px;
      background: var(--c-white);
      border: 1px solid var(--border-on-white);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      z-index: 999;
      display: none;
      max-width: 240px;
      padding: 10px 14px;
      font-size: 12px;
      line-height: 1.5;
      transform-origin: bottom right;
    }
    .voice-tooltip.visible {
      display: block;
      animation: tooltipIn 200ms var(--ease-out-quart);
    }
    @keyframes tooltipIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .voice-tooltip::after {
      content: '';
      position: absolute;
      bottom: -6px;
      right: 16px;
      width: 10px;
      height: 10px;
      background: var(--c-white);
      border-right: 1px solid var(--border-on-white);
      border-bottom: 1px solid var(--border-on-white);
      transform: rotate(45deg);
    }
    .voice-tooltip-status {
      color: var(--c-meta);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .voice-tooltip-text {
      color: var(--c-ink);
      word-break: break-word;
    }
    .voice-tooltip-text.dim { color: var(--c-meta); font-style: italic; }
    .voice-tooltip-result {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--border-on-white);
      color: #2E7D32;
      font-size: 11px;
    }
    .voice-tooltip-hint {
      margin-top: 6px;
      font-size: 9px;
      color: var(--c-meta);
      font-style: italic;
    }
    /* Input attention pulse when voice populates it */
    @keyframes inputAttention {
      0% { box-shadow: 0 0 0 0 rgba(17,17,17,0.15); }
      40% { box-shadow: 0 0 0 4px rgba(17,17,17,0.1); }
      100% { box-shadow: 0 0 0 0 rgba(17,17,17,0); }
    }
    .input-attention {
      animation: inputAttention 800ms var(--ease-out-quart);
    }
    /* Mini waveform inside tooltip */
    .voice-mini-wave {
      display: inline-flex; align-items: center; gap: 2px; height: 14px; margin-right: 6px; vertical-align: middle;
    }
    .voice-mini-wave .bar {
      width: 2px; background: var(--c-brand); border-radius: 1px; height: 3px;
    }
    .voice-mini-wave.active .bar { animation: miniWave 0.5s ease-in-out infinite alternate; }
    .voice-mini-wave.active .bar:nth-child(1) { animation-delay: 0ms; }
    .voice-mini-wave.active .bar:nth-child(2) { animation-delay: 70ms; }
    .voice-mini-wave.active .bar:nth-child(3) { animation-delay: 140ms; }
    .voice-mini-wave.active .bar:nth-child(4) { animation-delay: 210ms; }
    .voice-mini-wave.active .bar:nth-child(5) { animation-delay: 280ms; }
    @keyframes miniWave {
      0% { height: 3px; }
      100% { height: 12px; }
    }
    .voice-hint kbd {
      background: var(--c-bg-alt);
      border: 1px solid var(--border-on-white);
      padding: 1px 4px;
      font-size: 9px;
      font-family: var(--font-sans);
    }

    /* ========================================
       ANIMATIONS & MICRO-INTERACTIONS
       ======================================== */

    /* --- Hero: Chart bars grow upward on load --- */
    .chart-bar {
      transform-origin: bottom;
      animation: barGrow 600ms var(--ease-out-quart) backwards;
    }
    @keyframes barGrow {
      from { transform: scaleY(0); opacity: 0; }
      to { transform: scaleY(1); opacity: 1; }
    }
    /* Stagger bars via inline style --i set in JS */
    .chart-bar { animation-delay: calc(var(--i, 0) * 12ms); }

    /* --- Stat cells: staggered fade-in --- */
    .stat-cell {
      animation: fadeSlideUp 500ms var(--ease-out-quart) backwards;
    }
    .stat-cell:nth-child(1) { animation-delay: 80ms; }
    .stat-cell:nth-child(2) { animation-delay: 140ms; }
    .stat-cell:nth-child(3) { animation-delay: 200ms; }
    .stat-cell:nth-child(4) { animation-delay: 260ms; }
    .stat-cell:nth-child(5) { animation-delay: 320ms; }
    .stat-cell:nth-child(6) { animation-delay: 380ms; }
    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- Session rows: hover feedback --- */
    .session-row {
      transition: background-color 150ms, transform 150ms var(--ease-out-quart);
    }
    .session-row:hover {
      transform: translateX(4px);
    }

    /* --- Group rows: expand/collapse hint --- */
    .session-group-row {
      transition: background-color 150ms;
    }
    .group-badge {
      transition: transform 200ms var(--ease-out-quart);
    }
    .session-group-row:hover .group-badge {
      transform: scale(1.15);
    }

    /* --- Group expanded: slide in --- */
    .group-expanded {
      animation: expandIn 300ms var(--ease-out-quart);
    }
    @keyframes expandIn {
      from { opacity: 0; transform: translateY(-6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- Time group headers: fade in --- */
    .time-group-header {
      animation: fadeSlideUp 400ms var(--ease-out-quart) backwards;
    }

    /* --- Nav tabs: underline transition --- */
    .nav-tab {
      transition: opacity 200ms, border-bottom-color 250ms var(--ease-out-quart);
    }

    /* --- Smart filter chips: interaction --- */
    .smart-filter {
      transition: background-color 200ms, color 200ms, border-color 200ms, transform 150ms var(--ease-out-quart);
    }
    .smart-filter:active {
      transform: scale(0.95);
    }

    /* --- Granularity toggle: transition --- */
    .granularity-btn {
      transition: background-color 200ms, color 200ms, border-color 200ms;
    }

    /* --- Find input: focus glow --- */
    .find-session-input:focus {
      box-shadow: 0 0 0 3px rgba(17, 17, 17, 0.06);
      transform: translateY(-1px);
    }

    /* Search input focus animation merged into base .search-input above */

    /* --- Action cards: staggered entrance --- */
    .action-card {
      animation: fadeSlideUp 400ms var(--ease-out-quart) backwards;
    }
    .action-card:nth-child(1) { animation-delay: 50ms; }
    .action-card:nth-child(2) { animation-delay: 120ms; }
    .action-card:nth-child(3) { animation-delay: 190ms; }
    .action-card:nth-child(4) { animation-delay: 260ms; }
    .action-card:nth-child(5) { animation-delay: 330ms; }
    .action-card:nth-child(6) { animation-delay: 400ms; }
    .action-card:nth-child(7) { animation-delay: 470ms; }
    .action-card:nth-child(8) { animation-delay: 540ms; }

    /* --- Action buttons: feedback --- */
    .action-btn {
      transition: background-color 150ms, color 150ms, border-color 150ms, transform 100ms var(--ease-out-quart), opacity 150ms;
    }
    .action-btn:active {
      transform: scale(0.96);
    }

    /* --- Applied confirmation: slide in --- */
    .action-applied {
      animation: appliedPulse 400ms var(--ease-out-quart);
    }
    @keyframes appliedPulse {
      from { opacity: 0; transform: translateX(-8px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* --- Generate actions button --- */
    .generate-actions-btn {
      transition: opacity 200ms, transform 100ms var(--ease-out-quart);
    }
    .generate-actions-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    /* --- Loading spinner: smoother --- */
    .loading {
      animation: fadeIn 300ms var(--ease-out-quart);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* --- Back button --- */
    .back-btn {
      transition: background-color 150ms, transform 150ms var(--ease-out-quart);
    }
    .back-btn:active {
      transform: scale(0.96);
    }

    /* --- Session action links --- */
    .session-action-link {
      transition: background-color 150ms, color 150ms, border-color 150ms;
    }

    /* --- Tool bar fill: animate width --- */
    .tool-bar-fill {
      transition: width 500ms var(--ease-out-quart);
    }

    /* --- Chart bar: hover/selected uses animation not transition to avoid conflict with barGrow --- */

    /* --- Transcript messages: stagger (capped at 600ms total) --- */
    .transcript-msg {
      animation: fadeSlideUp 300ms var(--ease-out-quart) backwards;
      animation-delay: calc(min(var(--msg-i, 0), 20) * 30ms);
    }

    /* --- View switching: fade + slide content --- */
    .view.active {
      animation: viewEnter 200ms var(--ease-out-quart);
    }
    @keyframes viewEnter {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- Calendar cells: staggered pop-in --- */
    .calendar-day:not(.empty) {
      animation: cellReveal 300ms var(--ease-out-quart) backwards;
      animation-delay: calc(var(--ci, 0) * 6ms);
    }
    @keyframes cellReveal {
      from { opacity: 0; transform: scale(0.6); }
      to { opacity: 1; transform: scale(1); }
    }

    /* --- Swimlane cells: wave reveal per row --- */
    .swimlane-cell {
      animation: cellFade 250ms var(--ease-out-quart) backwards;
      animation-delay: calc(var(--ci, 0) * 4ms);
    }
    @keyframes cellFade {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* --- Date filter bar: slide in --- */
    .date-filter-bar.visible {
      animation: fadeSlideUp 300ms var(--ease-out-quart);
    }

    /* --- Pagination buttons --- */
    .pagination button {
      transition: background-color 150ms, opacity 150ms;
    }

    /* ========================================
       REDUCED MOTION
       ======================================== */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Left Panel -->
    <aside class="panel-brand">
      <header class="brand-header">
        <div class="logo">Session <span>Explorer</span></div>
        <div style="font-size: 11px; opacity: 0.6;" id="session-count">-- sessions</div>
      </header>

      <nav class="nav-tabs">
        <button class="nav-tab active" data-view="overview">Sessions</button>
        <button class="nav-tab" data-view="search">Semantic</button>
        <button class="nav-tab" data-view="session">Detail</button>
        <button class="nav-tab" data-view="insights">Insights</button>
      </nav>

      <div class="panel-brand-content">
        <!-- Overview left: stats grid -->
        <div class="view active" id="left-overview">
          <div class="stats-grid" id="stats-grid">
            <div class="stat-cell">
              <div class="stat-label">Sessions</div>
              <div class="stat-value" id="stat-sessions">--</div>
            </div>
            <div class="stat-cell">
              <div class="stat-label">Total Tokens</div>
              <div class="stat-value small" id="stat-tokens">--</div>
            </div>
            <div class="stat-cell">
              <div class="stat-label">Hours</div>
              <div class="stat-value" id="stat-hours">--</div>
            </div>
            <div class="stat-cell">
              <div class="stat-label">Avg Duration</div>
              <div class="stat-value small" id="stat-avg-duration">--</div>
            </div>
            <div class="stat-cell">
              <div class="stat-label">Lines Added</div>
              <div class="stat-value small" id="stat-lines-added">--</div>
            </div>
            <div class="stat-cell">
              <div class="stat-label">Lines Removed</div>
              <div class="stat-value small" id="stat-lines-removed">--</div>
            </div>
            <div class="stat-cell">
              <div class="stat-label">Est. Cost</div>
              <div class="stat-value small" id="stat-cost">--</div>
            </div>
            <div class="stat-cell">
              <div class="stat-label">Error Rate</div>
              <div class="stat-value small" id="stat-error-rate">--</div>
            </div>
          </div>
          <div class="insights-strip" id="insights-strip" style="display:none;"></div>
          <div class="tool-activity" id="tool-bars">
            <div class="tool-activity-header">Tool Distribution</div>
          </div>
          <div class="tool-activity" id="language-bars" style="display:none;">
            <div class="tool-activity-header">Languages</div>
          </div>
          <div class="error-rate-section" id="error-categories-section" style="display:none;">
            <div class="error-rate-header">Top Error Categories</div>
            <div id="error-categories"></div>
          </div>
          <div class="wellbeing-strip" id="wellbeing-strip" style="display:none;"></div>
        </div>

        <!-- Search left: input + filters -->
        <div class="view" id="left-search">
          <div class="search-panel">
            <div class="search-input-wrap">
              <input class="search-input" id="search-input" placeholder="Search sessions..." />
              <button class="search-btn" id="search-btn">Go</button>
            </div>
            <div class="filter-tags" id="search-filters">
              <button class="filter-tag" data-mode="semantic">Semantic</button>
              <button class="filter-tag active" data-mode="text">Text</button>
            </div>
          </div>
          <div class="agent-status" id="agent-status">
            <div class="label">Agent Activity</div>
            <div id="agent-tool-calls"></div>
          </div>
        </div>

        <!-- Session left: metadata -->
        <div class="view" id="left-session">
          <div class="session-meta-grid" id="session-meta-panel">
            <div style="padding: var(--space-md); opacity: 0.5; font-style: italic;">Select a session to view details</div>
          </div>
        </div>

        <!-- Insights left: nav + ask input + presets -->
        <div class="view" id="left-insights">
          <div class="insights-nav" id="insights-nav">
            <div class="insights-nav-item" data-action="load-report">
              Latest Report
              <span>View the most recent insights analysis</span>
            </div>
          </div>
          <div class="search-panel">
            <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.5; margin-bottom: var(--space-xs);">Ask about your usage</div>
            <div class="search-input-wrap">
              <input class="search-input" id="insights-input" placeholder="e.g. Which sessions used the most tokens?" />
              <button class="search-btn" id="insights-ask-btn">Ask</button>
            </div>
            <div style="margin-top: var(--space-xs);">
              <button class="filter-tag" id="suggestions-toggle" style="font-size:10px; cursor:pointer;">Suggestions</button>
            </div>
            <div id="insight-presets" style="margin-top: var(--space-xs);">
              <div style="font-size:9px; text-transform:uppercase; letter-spacing:0.5px; opacity:0.7; margin: var(--space-xs) 0 4px; color: var(--c-ink);">Wellbeing & Sustainability</div>
              <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px;">
                <button class="filter-tag insight-preset" data-q="On what days do I seem to be working too much and need more breaks? Look at session duration, late-night activity, and weekend work.">Overwork days</button>
                <button class="filter-tag insight-preset" data-q="Am I showing signs of burnout? Analyze my session patterns for unsustainable streaks: consecutive long days, shrinking breaks between sessions, increasing late-night work, or weekend coding binges.">Burnout check</button>
                <button class="filter-tag insight-preset" data-q="How are my work-life boundaries? Identify sessions that start very early or end very late. Flag days with more than 8 hours of total session time.">Work-life balance</button>
                <button class="filter-tag insight-preset" data-q="What does my rest and recovery pattern look like? Show gaps between sessions, days with no activity, and whether I take regular breaks during long sessions.">Rest patterns</button>
              </div>
              <div style="font-size:9px; text-transform:uppercase; letter-spacing:0.5px; opacity:0.4; margin: var(--space-xs) 0 4px;">Productivity</div>
              <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px;">
                <button class="filter-tag insight-preset" data-q="What are my most productive hours and days?">Peak hours</button>
                <button class="filter-tag insight-preset" data-q="Compare my productivity this week vs last week. Tokens, sessions, lines changed.">Week comparison</button>
                <button class="filter-tag insight-preset" data-q="Which projects take the most tokens per session? Am I over-spending on any?">Token efficiency</button>
              </div>
              <div style="font-size:9px; text-transform:uppercase; letter-spacing:0.5px; opacity:0.4; margin: var(--space-xs) 0 4px;">Errors & Quality</div>
              <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px;">
                <button class="filter-tag insight-preset" data-q="What are the most common error categories? Which projects have the highest error rates?">Error patterns</button>
                <button class="filter-tag insight-preset" data-q="Find sessions where I retried the same operation multiple times. What went wrong?">Retry patterns</button>
                <button class="filter-tag insight-preset" data-q="Which tools fail most often? Should I change my approach?">Tool reliability</button>
              </div>
              <div style="font-size:9px; text-transform:uppercase; letter-spacing:0.5px; opacity:0.4; margin: var(--space-xs) 0 4px;">Workflow & Strategy</div>
              <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px;">
                <button class="filter-tag insight-preset" data-q="Analyze my tool usage patterns. Am I using the right tools for each task?">Tool usage audit</button>
                <button class="filter-tag insight-preset" data-q="Which sessions were most cost-effective? What patterns made them efficient?">Cost optimization</button>
                <button class="filter-tag insight-preset" data-q="What frameworks, libraries and technologies am I using most? How has this changed over time?">Tech stack trends</button>
                <button class="filter-tag insight-preset" data-q="Identify sessions that could have been shorter. What patterns lead to long sessions?">Session optimization</button>
              </div>
              <div style="font-size:9px; text-transform:uppercase; letter-spacing:0.5px; opacity:0.4; margin: var(--space-xs) 0 4px;">Research & Discovery</div>
              <div style="display:flex; flex-wrap:wrap; gap:4px;">
                <button class="filter-tag insight-preset" data-q="Find sessions involving research, web search, or documentation lookups. What was I exploring?">Research sessions</button>
                <button class="filter-tag insight-preset" data-q="What topics or technologies have I been learning about recently?">Learning patterns</button>
                <button class="filter-tag insight-preset" data-q="Which projects haven't been touched recently? Should I revisit any?">Stale projects</button>
              </div>
            </div>
          </div>
          <div class="report-index" id="report-index" style="display:none;">
            <div class="report-index-title">Recent Reports</div>
            <div id="report-index-list"></div>
          </div>
        </div>
      </div>

      <footer class="brand-footer">
        <span>Claude Code</span>
        <span id="footer-date"></span>
      </footer>
    </aside>

    <!-- Right Panel -->
    <main class="panel-content">
      <!-- Overview right: find + chart + grouped sessions -->
      <div class="view active" id="right-overview">
        <div class="content-header" style="padding-bottom: var(--space-sm);">
          <div class="find-session-bar">
            <h1 style="font-weight: 400; font-size: 28px; letter-spacing: -0.5px; margin-right: var(--space-sm); white-space: nowrap;">Find Session</h1>
            <input class="find-session-input" id="find-input" placeholder="Search by keyword, project, or topic..." />
          </div>
          <div class="smart-filters" id="smart-filters"></div>
        </div>
        <div class="content-body">
          <div class="activity-chart">
            <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs);">
              <div class="chart-title" style="margin-bottom: 0;">Activity</div>
              <div class="granularity-toggle" id="granularity-toggle">
                <button class="granularity-btn" data-granularity="day">Day</button>
                <button class="granularity-btn active" data-granularity="week">Week</button>
                <button class="granularity-btn" data-granularity="month">Month</button>
              </div>
            </div>
            <div class="chart-bars" id="daily-chart"></div>
            <div class="chart-dates" id="chart-dates"></div>
          </div>
          <div class="quick-actions" id="quick-actions">
            <button class="quick-action-btn" data-insight-query="Suggest improvements for my coding workflow based on recent sessions">Suggest improvements</button>
            <button class="quick-action-btn" data-insight-query="Show error patterns across my recent sessions and how to fix them">Show error patterns</button>
            <button class="quick-action-btn" data-insight-query="Analyze my productivity trends this week vs last week">Analyze productivity</button>
          </div>
          <div class="heatmap-section" id="heatmap-section" style="display:none;">
            <div class="heatmap-title collapsible-header expanded" data-target="heatmap-body">Activity Heatmap (Hour x Day)</div>
            <div class="collapsible-body expanded" id="heatmap-body">
              <div class="heatmap-grid" id="heatmap-grid"></div>
            </div>
          </div>
          <div class="calendar-section" id="calendar-section" style="display:none;">
            <div class="calendar-header">
              <span class="calendar-title collapsible-header" data-target="calendar-body">Activity Calendar (90 days)</span>
              <div style="display:flex;align-items:center;gap:4px;">
                <div class="calendar-modes" id="calendar-modes">
                  <button class="calendar-mode-btn active" data-mode="sessions">Sessions</button>
                  <button class="calendar-mode-btn" data-mode="duration">Duration</button>
                  <button class="calendar-mode-btn" data-mode="focus">Focus</button>
                  <button class="calendar-mode-btn" data-mode="cost">Cost</button>
                  <button class="calendar-mode-btn" data-mode="lines">Lines</button>
                </div>
                <button class="calendar-export-btn" id="calendar-export-csv" title="Export as CSV">CSV</button>
                <button class="calendar-export-btn" id="calendar-export-md" title="Export as Markdown">MD</button>
              </div>
            </div>
            <div class="collapsible-body" id="calendar-body">
              <div class="calendar-filters" id="calendar-filters">
                <button class="calendar-filter-btn health" data-filter="health"><span class="filter-icon">!</span> Health</button>
                <button class="calendar-filter-btn night" data-filter="night"><span class="filter-icon">*</span> Night Owl</button>
                <button class="calendar-filter-btn streak" data-filter="streak"><span class="filter-icon">#</span> Streaks</button>
                <button class="calendar-filter-btn trend" data-filter="trend"><span class="filter-icon">~</span> Trends</button>
              </div>
              <div class="calendar-grid" id="calendar-grid"></div>
              <div class="calendar-legend" id="calendar-legend"></div>
              <div class="calendar-trends" id="calendar-trends"></div>
            </div>
          </div>
          <div class="swimlane-section" id="swimlane-section" style="display:none;">
            <div class="swimlane-title collapsible-header" data-target="swimlane-body" id="swimlane-toggle">
              <span>Project Activity (30 days)</span>
            </div>
            <div class="collapsible-body" id="swimlane-body">
              <div class="swimlane-grid" id="swimlane-grid"></div>
            </div>
          </div>
          <div class="date-filter-bar" id="date-filter-bar">
            <span class="date-filter-label" id="date-filter-label"></span>
            <button class="date-filter-clear" id="date-filter-clear">Clear filter</button>
          </div>
          <div class="session-list" id="recent-sessions"></div>
          <div class="pagination" id="pagination">
            <button id="prev-page" disabled>&larr; Prev</button>
            <span id="page-info">1 / 1</span>
            <button id="next-page">&rarr; Next</button>
          </div>
        </div>
      </div>

      <!-- Search right: results -->
      <div class="view" id="right-search">
        <div class="content-header">
          <span class="meta-label">Search</span>
          <h1>Session Search</h1>
        </div>
        <div class="content-body">
          <div class="loading" id="search-loading">Searching</div>
          <div class="agent-response" id="search-response"></div>
          <div class="session-list" id="search-results"></div>
        </div>
      </div>

      <!-- Session right: detail -->
      <div class="view" id="right-session">
        <div class="content-header" style="display:flex; align-items:flex-start; justify-content:space-between;">
          <div>
            <span class="meta-label">Session Detail</span>
            <h1 id="session-title">Select a Session</h1>
          </div>
          <button class="back-btn" id="back-to-list">&larr; Back to list</button>
        </div>
        <div class="content-body">
          <div class="session-detail" id="session-detail"></div>
        </div>
      </div>

      <!-- Insights right: actions + report list -->
      <div class="view" id="right-insights">
        <div class="content-header">
          <span class="meta-label">Insights</span>
          <h1>Actionable Insights</h1>
        </div>
        <div class="content-body">
          <button class="generate-actions-btn" id="generate-actions-btn">Generate Actions</button>
          <div class="loading" id="insights-loading"><span id="insights-loading-text">Analyzing sessions</span></div>
          <div class="action-cards" id="action-cards"></div>
          <div class="insights-content" id="insights-content"></div>
          <div id="report-list-container">
            <div class="report-list-header" id="report-list-header" style="display:none;">
              <h3>Generated Reports</h3>
              <div style="display:flex; gap:8px; align-items:center;">
                <button class="report-action-btn" id="report-review-btn" title="Review as flashcards">Review</button>
                <button class="report-clear-btn" id="report-clear-btn">Clear all</button>
              </div>
            </div>
            <div class="report-list" id="report-list"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Flashcard review overlay -->
  <div class="flashcard-overlay" id="flashcard-overlay" role="dialog" aria-label="Report review cards">
    <div class="flashcard">
      <div class="flashcard-header">
        <div class="flashcard-header-left">
          <span class="flashcard-counter" id="flashcard-counter">1/1</span>
          <span class="flashcard-title" id="flashcard-title"></span>
        </div>
        <button class="flashcard-close" id="flashcard-close">&times;</button>
      </div>
      <div class="flashcard-progress"><div class="flashcard-progress-fill" id="flashcard-progress"></div></div>
      <div class="flashcard-slide-wrap">
        <div class="flashcard-body agent-response visible" id="flashcard-body"></div>
      </div>
      <div class="flashcard-nav">
        <button class="flashcard-nav-btn" id="flashcard-prev">&larr; Prev</button>
        <div class="flashcard-nav-center" id="flashcard-dots"></div>
        <button class="flashcard-nav-btn" id="flashcard-next">Next &rarr;</button>
      </div>
    </div>
  </div>

  <!-- Voice FAB -->
  <button id="voice-btn" class="voice-fab idle" title="Click to speak a command">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
  </button>

  <!-- Compact voice tooltip -->
  <div id="voice-tooltip" class="voice-tooltip">
    <div class="voice-tooltip-status" id="voice-tooltip-status">Ready</div>
    <div>
      <span class="voice-mini-wave" id="voice-mini-wave">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
        <span class="bar"></span><span class="bar"></span>
      </span>
      <span class="voice-tooltip-text dim" id="voice-tooltip-text">Speak a command...</span>
    </div>
    <div class="voice-tooltip-result" id="voice-tooltip-result" style="display:none;"></div>
    <div class="voice-tooltip-hint" id="voice-tooltip-hint" style="display:none;"></div>
  </div>

  <script>
    // --- State ---
    const state = {
      currentView: 'overview',
      sessions: [],
      allSessions: [], // unfiltered
      stats: null,
      page: 1,
      totalPages: 1,
      searchMode: 'text',
      currentSessionId: null,
      dateFilter: null,
      expandedGroups: new Set(),
      granularity: 'week', // 'day' | 'week' | 'month'
      findQuery: '',
      activeFilters: new Set(), // multi-select smart filter keys
      smartFilters: [], // [{label, key, count}]
      insightsCache: JSON.parse(localStorage.getItem('insightsCache') || '{}'), // sessionId -> { text, cost, turns }
    };

    // --- Navigation ---
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        switchView(tab.dataset.view);
      });
    });

    function saveInsightsCache() {
      try { localStorage.setItem('insightsCache', JSON.stringify(state.insightsCache)); } catch {}
    }

    function switchView(view, updateHash = true) {
      state.currentView = view;
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
      ['overview', 'search', 'session', 'insights'].forEach(v => {
        document.getElementById(`left-${v}`).classList.toggle('active', v === view);
        document.getElementById(`right-${v}`).classList.toggle('active', v === view);
      });
      // Update URL hash for reloadable state
      if (updateHash) {
        const hash = buildHash();
        history.replaceState(null, '', hash);
      }
    }

    // --- URL Hash Routing ---
    function buildHash() {
      const parts = [`view=${state.currentView}`];
      if (state.currentSessionId && state.currentView === 'session') {
        parts.push(`session=${state.currentSessionId}`);
      }
      if (state.activeFilters.size > 0) {
        parts.push(`filters=${[...state.activeFilters].map(encodeURIComponent).join(',')}`);
      }
      if (state.findQuery) {
        parts.push(`q=${encodeURIComponent(state.findQuery)}`);
      }
      if (state.dateFilter) {
        parts.push(`date=${state.dateFilter}`);
      }
      return '#' + parts.join('&');
    }

    function restoreFromHash() {
      const hash = location.hash.slice(1);
      if (!hash) return;
      const params = {};
      for (const part of hash.split('&')) {
        const [k, v] = part.split('=');
        if (k && v) params[k] = decodeURIComponent(v);
      }

      if (params.view) {
        switchView(params.view, false);
      }
      if (params.filters) {
        for (const f of params.filters.split(',')) {
          state.activeFilters.add(decodeURIComponent(f));
        }
      }
      if (params.q) {
        state.findQuery = params.q;
        document.getElementById('find-input').value = params.q;
      }
      if (params.date) {
        setDateFilter(params.date);
      }
      if (params.session) {
        // Defer session open until sessions are loaded
        state._pendingSessionId = params.session;
      }
    }

    window.addEventListener('hashchange', () => restoreFromHash());

    // --- Format helpers ---
    function formatTokens(n) {
      if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
      if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
      if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
      return String(n);
    }

    function formatDate(iso) {
      if (!iso) return '--';
      const d = new Date(iso);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
             d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function shortProject(path) {
      if (!path) return '';
      const parts = path.split('/').filter(Boolean);
      return parts.slice(-2).join('/');
    }

    function escapeHtml(s) {
      if (typeof s !== 'string') return String(s);
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // --- Hardened fetch: checks res.ok, supports timeout via AbortController ---
    async function safeFetch(url, opts = {}) {
      const { timeout = 30000, ...fetchOpts } = opts;
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeout);
      try {
        const res = await fetch(url, { ...fetchOpts, signal: controller.signal });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        return res;
      } finally {
        clearTimeout(timer);
      }
    }

    // Reduced-motion check
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // --- Load Stats ---
    async function loadStats() {
      try {
        const res = await safeFetch('/api/stats');
        const data = await res.json();
        state.stats = data;

        document.getElementById('stat-sessions').textContent = data.total_sessions;
        document.getElementById('stat-tokens').textContent = formatTokens(data.total_tokens);
        document.getElementById('stat-hours').textContent = data.total_duration_hours;
        document.getElementById('stat-avg-duration').textContent = data.avg_duration_min + 'm';
        document.getElementById('stat-lines-added').textContent = '+' + formatTokens(data.total_lines.added);
        document.getElementById('stat-lines-removed').textContent = '-' + formatTokens(data.total_lines.removed);
        document.getElementById('session-count').textContent = data.total_sessions + ' sessions';

        // Cost stat
        document.getElementById('stat-cost').textContent = '$' + (data.estimated_cost || 0).toFixed(0);

        // Error rate stat with color
        const errEl = document.getElementById('stat-error-rate');
        const errRate = data.error_rate || 0;
        errEl.textContent = errRate + '%';
        errEl.className = 'stat-value small' + (errRate > 40 ? ' error-rate-value high' : errRate > 20 ? ' error-rate-value medium' : ' error-rate-value low');

        // Tool bars
        renderToolBars(data.top_tools);

        // Language bars
        if (data.top_languages && data.top_languages.length > 0) {
          renderLanguageBars(data.top_languages);
        }

        // Error categories
        if (data.top_error_categories && data.top_error_categories.length > 0) {
          renderErrorCategories(data.top_error_categories);
        }

        // Heatmap
        if (data.hourly_activity && data.dow_activity) {
          renderHeatmap(data.hourly_activity, data.dow_activity);
        }

        // Week-over-week trends
        if (data.daily_activity) {
          computeAndRenderTrends(data.daily_activity);
        }

        // Activity chart (responds to granularity)
        state.dailyData = data.daily_activity;
        renderChart();
      } catch (e) {
        console.error('Failed to load stats:', e);
        document.getElementById('stat-sessions').textContent = '--';
        document.getElementById('session-count').textContent = e.name === 'AbortError' ? 'Server timeout' : 'Connection error';
      }
    }

    function renderToolBars(tools) {
      const container = document.getElementById('tool-bars');
      const max = tools.length > 0 ? tools[0][1] : 1;
      let html = '<div class="tool-activity-header">Tool Distribution</div>';
      for (const [name, count] of tools) {
        const pct = (count / max * 100).toFixed(1);
        html += `<div class="tool-bar-row">
          <span class="tool-bar-label" title="${escapeHtml(name)}">${escapeHtml(name)}</span>
          <span class="tool-bar-track"><span class="tool-bar-fill" style="width:${pct}%"></span></span>
          <span class="tool-bar-count">${formatTokens(count)}</span>
        </div>`;
      }
      container.innerHTML = html;
    }

    function renderLanguageBars(languages) {
      const container = document.getElementById('language-bars');
      container.style.display = '';
      const max = languages.length > 0 ? languages[0][1] : 1;
      let html = '<div class="tool-activity-header">Languages</div>';
      for (const [name, count] of languages.slice(0, 5)) {
        const pct = (count / max * 100).toFixed(1);
        html += `<div class="tool-bar-row">
          <span class="tool-bar-label" title="${escapeHtml(name)}">${escapeHtml(name)}</span>
          <span class="tool-bar-track"><span class="tool-bar-fill" style="width:${pct}%"></span></span>
          <span class="tool-bar-count">${formatTokens(count)}</span>
        </div>`;
      }
      container.innerHTML = html;
    }

    function renderErrorCategories(categories) {
      const section = document.getElementById('error-categories-section');
      section.style.display = '';
      const container = document.getElementById('error-categories');
      const max = categories.length > 0 ? categories[0][1] : 1;
      let html = '';
      for (const [name, count] of categories) {
        const pct = (count / max * 100).toFixed(1);
        html += `<div class="tool-bar-row">
          <span class="tool-bar-label" title="${escapeHtml(name)}">${escapeHtml(name)}</span>
          <span class="tool-bar-track"><span class="tool-bar-fill" style="width:${pct}%;background:#C62828;opacity:0.4"></span></span>
          <span class="tool-bar-count">${count}</span>
        </div>`;
      }
      container.innerHTML = html;
    }

    function renderHeatmap(hourlyActivity, dowActivity) {
      // Build a combined dow x hour grid from allSessions when available
      // For now, show hour distribution with dow as separate dimension
      const section = document.getElementById('heatmap-section');
      section.style.display = '';
      const grid = document.getElementById('heatmap-grid');

      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      // We need per-dow-per-hour data. We'll compute from allSessions later.
      // For now, approximate: distribute hourly counts proportionally by dow
      const totalDow = Object.values(dowActivity).reduce((s, v) => s + v, 0) || 1;
      const totalHour = Object.values(hourlyActivity).reduce((s, v) => s + v, 0) || 1;

      let maxCell = 0;
      const cells = {};
      for (let d = 0; d < 7; d++) {
        const dowFrac = (dowActivity[d] || 0) / totalDow;
        for (let h = 0; h < 24; h++) {
          const hourCount = hourlyActivity[h] || 0;
          const val = Math.round(hourCount * dowFrac);
          cells[`${d}-${h}`] = val;
          if (val > maxCell) maxCell = val;
        }
      }

      let html = '<span class="heatmap-row-label"></span>';
      // Hour labels
      for (let h = 0; h < 24; h++) {
        html += `<span class="heatmap-col-label">${h % 3 === 0 ? h : ''}</span>`;
      }

      // Rows (Mon first)
      const dayOrder = [1, 2, 3, 4, 5, 6, 0]; // Mon-Sun
      for (const d of dayOrder) {
        html += `<span class="heatmap-row-label">${dayNames[d]}</span>`;
        for (let h = 0; h < 24; h++) {
          const val = cells[`${d}-${h}`] || 0;
          const opacity = maxCell > 0 ? Math.max(0.05, val / maxCell) : 0.05;
          html += `<span class="heatmap-cell" style="opacity:${opacity.toFixed(2)}" data-tooltip="${dayNames[d]} ${h}:00 - ${val} msgs"></span>`;
        }
      }

      grid.innerHTML = html;
    }

    function computeAndRenderTrends(dailyActivity) {
      // Compare this week vs last week
      const now = new Date();
      const todayStr = now.toISOString().slice(0, 10);
      const dow = now.getDay();
      const mondayOffset = dow === 0 ? -6 : 1 - dow;
      const thisMonday = new Date(now);
      thisMonday.setDate(now.getDate() + mondayOffset);
      const lastMonday = new Date(thisMonday);
      lastMonday.setDate(thisMonday.getDate() - 7);

      function weekTotal(startDate, data) {
        let total = 0;
        for (let i = 0; i < 7; i++) {
          const d = new Date(startDate);
          d.setDate(startDate.getDate() + i);
          const key = d.toISOString().slice(0, 10);
          const entry = data.find(([k]) => k === key);
          if (entry) total += entry[1];
        }
        return total;
      }

      const thisWeekSessions = weekTotal(thisMonday, dailyActivity);
      const lastWeekSessions = weekTotal(lastMonday, dailyActivity);

      const sessionEl = document.getElementById('stat-sessions');
      if (lastWeekSessions > 0) {
        const pctChange = Math.round(((thisWeekSessions - lastWeekSessions) / lastWeekSessions) * 100);
        const arrow = pctChange > 0 ? '' : pctChange < 0 ? '' : '-';
        const cls = pctChange > 0 ? 'up' : pctChange < 0 ? 'down' : 'flat';
        const trendEl = document.createElement('div');
        trendEl.className = `stat-trend ${cls}`;
        trendEl.textContent = `${arrow} ${Math.abs(pctChange)}% vs last wk`;
        sessionEl.parentElement.appendChild(trendEl);
      }
    }

    function computeQuickInsights(stats, sessions) {
      const strip = document.getElementById('insights-strip');
      const chips = [];

      // Error rate insight
      if (stats.error_rate > 30) {
        const topErr = stats.top_error_categories?.[0];
        const errLabel = topErr ? topErr[0] : 'unknown';
        chips.push(`${stats.error_rate}% of sessions had errors. Most common: ${errLabel}`);
      }

      // Peak hours insight
      if (stats.hourly_activity) {
        const hours = Object.entries(stats.hourly_activity).sort((a, b) => b[1] - a[1]);
        if (hours.length > 0) {
          const peak = hours.slice(0, 3).map(([h]) => h + ':00').join(', ');
          chips.push(`Peak hours: ${peak}`);
        }
      }

      // Week-over-week trend
      if (stats.daily_activity) {
        const now = new Date();
        const dow = now.getDay();
        const mondayOffset = dow === 0 ? -6 : 1 - dow;
        const thisMonday = new Date(now);
        thisMonday.setDate(now.getDate() + mondayOffset);
        const lastMonday = new Date(thisMonday);
        lastMonday.setDate(thisMonday.getDate() - 7);

        let thisWeek = 0, lastWeek = 0;
        for (const [date, count] of stats.daily_activity) {
          const d = new Date(date + 'T12:00:00');
          if (d >= thisMonday) thisWeek += count;
          else if (d >= lastMonday && d < thisMonday) lastWeek += count;
        }
        if (lastWeek > 0) {
          const pct = Math.round(((thisWeek - lastWeek) / lastWeek) * 100);
          if (pct !== 0) {
            chips.push(`This week: ${pct > 0 ? pct + '% more' : Math.abs(pct) + '% fewer'} sessions than last week`);
          }
        }
      }

      // Stale projects
      if (sessions.length > 0) {
        const projectLastSeen = {};
        for (const s of sessions) {
          const proj = shortProject(s.project);
          if (proj && !projectLastSeen[proj]) {
            projectLastSeen[proj] = s.start_time;
          }
        }
        const now = Date.now();
        for (const [proj, lastTime] of Object.entries(projectLastSeen)) {
          const daysSince = Math.floor((now - new Date(lastTime).getTime()) / 86400000);
          if (daysSince >= 14) {
            chips.push(`Haven't touched ${proj} in ${daysSince} days`);
            break; // just one stale project
          }
        }
      }

      if (chips.length > 0) {
        strip.style.display = '';
        strip.innerHTML = chips.map(c =>
          `<span class="insight-chip">${escapeHtml(c)}</span>`
        ).join('');
      }
    }

    // --- SVG Sparklines ---
    function renderSparkline(containerId, dailyData, days = 14) {
      const container = document.getElementById(containerId);
      if (!container) return;
      // Get last N days of data
      const now = new Date();
      const values = [];
      for (let i = days - 1; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0, 10);
        const entry = dailyData.find(([k]) => k === key);
        values.push(entry ? entry[1] : 0);
      }

      const max = Math.max(...values, 1);
      const w = 80, h = 20;
      const points = values.map((v, i) => {
        const x = (i / (values.length - 1)) * w;
        const y = h - (v / max) * h;
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(' ');

      const existingSpark = container.querySelector('.stat-sparkline');
      if (existingSpark) existingSpark.remove();

      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'stat-sparkline');
      svg.setAttribute('width', w);
      svg.setAttribute('height', h);
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.innerHTML = `<polyline points="${points}"/>`;
      container.appendChild(svg);
    }

    function renderSparklines() {
      if (!state.stats?.daily_activity) return;
      // Session count sparkline
      renderSparkline('stat-sessions', state.stats.daily_activity);

      // Token sparkline from allSessions
      if (state.allSessions.length > 0) {
        const tokenDaily = {};
        const linesDaily = {};
        for (const s of state.allSessions) {
          const day = s.start_time?.slice(0, 10);
          if (!day) continue;
          tokenDaily[day] = (tokenDaily[day] || 0) + (s.input_tokens || 0) + (s.output_tokens || 0);
          linesDaily[day] = (linesDaily[day] || 0) + (s.lines_added || 0);
        }
        const tokenEntries = Object.entries(tokenDaily).sort((a, b) => a[0].localeCompare(b[0]));
        const linesEntries = Object.entries(linesDaily).sort((a, b) => a[0].localeCompare(b[0]));
        renderSparkline('stat-tokens', tokenEntries);
        renderSparkline('stat-lines-added', linesEntries);
      }
    }

    // --- Project Swimlane Timeline ---
    function renderSwimlane() {
      const pa = state.stats?.project_activity;
      if (!pa || !pa.projects || pa.projects.length === 0) return;

      const section = document.getElementById('swimlane-section');
      const grid = document.getElementById('swimlane-grid');

      // Get last 30 days
      const now = new Date();
      const days = [];
      for (let i = 29; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        days.push(d.toISOString().slice(0, 10));
      }

      section.style.display = '';
      grid.style.gridTemplateColumns = `100px repeat(${days.length}, 1fr)`;

      let html = '';
      // Date header row
      html += '<span class="swimlane-label"></span>';
      for (let i = 0; i < days.length; i++) {
        const label = i % 7 === 0 ? days[i].slice(5) : '';
        html += `<span class="swimlane-date-label">${label}</span>`;
      }

      for (let r = 0; r < pa.projects.length; r++) {
        const proj = pa.projects[r];
        const shortName = proj.split('/').pop();
        const projData = pa.data[proj] || {};
        html += `<span class="swimlane-label" title="${escapeHtml(proj)}">${escapeHtml(shortName)}</span>`;
        for (let c = 0; c < days.length; c++) {
          const day = days[c];
          const count = projData[day] || 0;
          const cls = count > 0 ? 'swimlane-cell active' : 'swimlane-cell';
          const opacity = count > 0 ? Math.min(0.3 + count * 0.2, 1) : 1;
          const ci = c + r * 3; // diagonal wave: column + offset per row
          html += `<span class="${cls}" style="--ci:${ci};${count > 0 ? `opacity:${opacity}` : ''}" data-tooltip="${escapeHtml(proj)} ${day}: ${count} sessions"></span>`;
        }
      }

      grid.innerHTML = html;
    }

    // Generic collapsible section toggle
    document.querySelectorAll('.collapsible-header').forEach(header => {
      header.addEventListener('click', () => {
        const targetId = header.dataset.target;
        if (!targetId) return;
        const body = document.getElementById(targetId);
        if (!body) return;
        header.classList.toggle('expanded');
        body.classList.toggle('expanded');
      });
    });

    // --- Calendar Module ---
    let calendarMode = 'sessions'; // 'sessions' | 'duration' | 'focus' | 'cost' | 'lines'

    function renderCalendar() {
      const calDays = state.stats?.calendar_days;
      if (!calDays || calDays.length === 0) return;

      const section = document.getElementById('calendar-section');
      if (!section) return;
      section.style.display = '';

      const grid = document.getElementById('calendar-grid');
      const todayStr = new Date().toISOString().slice(0, 10);

      // Color scales per mode
      const colorScales = {
        sessions: { color: [255, 77, 59], label: 'Sessions' },      // brand red
        duration: { color: [21, 101, 192], label: 'Duration (min)' }, // blue
        focus:    { color: [46, 125, 50], label: 'Focus (1=single project)' }, // green
        cost:     { color: [230, 81, 0], label: 'Est. Cost ($)' },    // orange
        lines:    { color: [123, 31, 162], label: 'Lines Added' },    // purple
      };

      function getValue(d) {
        switch (calendarMode) {
          case 'sessions': return d.sessions;
          case 'duration': return d.duration;
          case 'focus': return d.projects > 0 ? (1 / d.projects) : 0; // inverse: 1 project = max focus
          case 'cost': return d.cost;
          case 'lines': return d.linesAdded;
          default: return d.sessions;
        }
      }

      const values = calDays.map(getValue);
      const maxVal = Math.max(...values, 1);
      const scale = colorScales[calendarMode];

      // Group by week rows with month labels
      let html = '';
      // Weekday headers
      html += '<span class="calendar-week-label"></span>';
      const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      for (const dl of dayLabels) {
        html += `<span class="calendar-weekday">${dl}</span>`;
      }

      let currentMonth = '';
      let weekBuffer = [];
      let cellIdx = 0;

      for (let i = 0; i < calDays.length; i++) {
        const d = calDays[i];
        const date = new Date(d.date + 'T12:00:00');
        const dow = date.getDay(); // 0=Sun
        const mondayIdx = dow === 0 ? 6 : dow - 1; // 0=Mon

        const month = date.toLocaleDateString('en-US', { month: 'short' });
        const monthKey = d.date.slice(0, 7);

        // New month label
        if (monthKey !== currentMonth) {
          // Flush current week buffer first
          if (weekBuffer.length > 0) {
            html += flushWeek(weekBuffer);
            weekBuffer = [];
          }
          currentMonth = monthKey;
          html += `<div class="calendar-month-row">${date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</div>`;
          // Add empty cells for offset to correct weekday
          const weekLabel = d.date.slice(8, 10);
          html += `<span class="calendar-week-label">${weekLabel}</span>`;
          for (let j = 0; j < mondayIdx; j++) {
            html += '<span class="calendar-day empty"></span>';
          }
          weekBuffer = new Array(mondayIdx).fill(null);
        }

        // Start new week row if needed
        if (mondayIdx === 0 && weekBuffer.length > 0) {
          html += flushWeek(weekBuffer);
          weekBuffer = [];
          const weekLabel = d.date.slice(8, 10);
          html += `<span class="calendar-week-label">${weekLabel}</span>`;
        }

        const val = getValue(d);
        const intensity = maxVal > 0 ? val / maxVal : 0;
        const alpha = d.sessions > 0 ? Math.max(0.1, intensity) : 0.03;
        const bg = `rgba(${scale.color.join(',')},${alpha.toFixed(2)})`;

        const isToday = d.date === todayStr;
        const classes = ['calendar-day'];
        if (isToday) classes.push('today');
        if (d.danger) classes.push('danger');
        if (d.lateNight) classes.push('late-night');
        if (d.sessions === 0) classes.push('empty');

        const dayNum = date.getDate();
        const tooltipParts = [d.date];
        if (d.sessions > 0) {
          tooltipParts.push(`${d.sessions} sessions, ${d.duration}min`);
          tooltipParts.push(`${d.projects} project${d.projects !== 1 ? 's' : ''}, $${d.cost.toFixed(2)}`);
          if (d.linesAdded > 0) tooltipParts.push(`+${d.linesAdded} lines`);
          if (d.danger) tooltipParts.push('-- HEAVY DAY');
          if (d.lateNight) tooltipParts.push('Late night work');
        } else {
          tooltipParts.push('No activity');
        }

        // Format display value for the cell
        let displayVal = '';
        if (d.sessions > 0 && val > 0) {
          if (calendarMode === 'cost') displayVal = '$' + (val < 1 ? val.toFixed(2) : val.toFixed(0));
          else if (calendarMode === 'focus') displayVal = val.toFixed(1);
          else if (calendarMode === 'duration') displayVal = val >= 60 ? (val / 60).toFixed(1) + 'h' : val + 'm';
          else if (calendarMode === 'lines') displayVal = val >= 1000 ? (val / 1000).toFixed(1) + 'k' : String(val);
          else displayVal = String(val);
        }
        // Proportional font-size: 8px at low, 12px at max
        const valFontSize = d.sessions > 0 ? (8 + 4 * intensity).toFixed(1) : 8;
        html += `<span class="${classes.join(' ')}" style="--ci:${cellIdx};background:${bg}" data-date="${d.date}" data-tooltip="${tooltipParts.join('\n')}"><span class="day-number">${dayNum}</span>${displayVal ? `<span class="day-value" style="font-size:${valFontSize}px">${displayVal}</span>` : ''}</span>`;
        if (d.sessions > 0) cellIdx++;
        weekBuffer.push(d);
      }

      // Flush remaining
      if (weekBuffer.length > 0) {
        html += flushWeek(weekBuffer);
      }

      function flushWeek(buf) {
        // Pad to 7 days
        let pad = '';
        for (let j = buf.length; j < 7; j++) {
          pad += '<span class="calendar-day empty"></span>';
        }
        return pad;
      }

      grid.innerHTML = html;

      // Legend
      const legend = document.getElementById('calendar-legend');
      if (legend) {
        legend.innerHTML = `
          <span class="calendar-legend-item"><span class="calendar-legend-swatch" style="background:rgba(${scale.color.join(',')},0.1)"></span>Low</span>
          <span class="calendar-legend-item"><span class="calendar-legend-swatch" style="background:rgba(${scale.color.join(',')},0.5)"></span>Medium</span>
          <span class="calendar-legend-item"><span class="calendar-legend-swatch" style="background:rgba(${scale.color.join(',')},1)"></span>High</span>
          <span class="calendar-legend-item"><span class="calendar-legend-swatch" style="background:#C62828;border-radius:50%;width:6px;height:6px"></span>Heavy day</span>
          <span class="calendar-legend-item"><span class="calendar-legend-swatch" style="background:#7B1FA2;border-radius:50%;width:5px;height:5px"></span>Late night</span>
        `;
      }

      // Render trend summary
      renderCalendarTrends(calDays);
      // Re-apply active filter if any
      if (calendarFilter) applyCalendarFilter();
    }

    // Calendar mode switcher
    document.getElementById('calendar-modes')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.calendar-mode-btn');
      if (!btn) return;
      calendarMode = btn.dataset.mode;
      document.querySelectorAll('.calendar-mode-btn').forEach(b =>
        b.classList.toggle('active', b === btn)
      );
      renderCalendar();
    });

    // Calendar click: filter to that date
    document.getElementById('calendar-grid')?.addEventListener('click', (e) => {
      const cell = e.target.closest('.calendar-day');
      if (!cell || cell.classList.contains('empty')) return;
      const date = cell.dataset.date;
      if (date) setDateFilter(date);
    });

    // --- Calendar Filters ---
    let calendarFilter = null; // null | 'health' | 'night' | 'streak' | 'trend'

    document.getElementById('calendar-filters')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.calendar-filter-btn');
      if (!btn) return;
      const filter = btn.dataset.filter;
      if (calendarFilter === filter) {
        calendarFilter = null;
        btn.classList.remove('active');
      } else {
        calendarFilter = filter;
        document.querySelectorAll('.calendar-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      }
      applyCalendarFilter();
    });

    function applyCalendarFilter() {
      const calDays = state.stats?.calendar_days;
      if (!calDays) return;
      const cells = document.querySelectorAll('#calendar-grid .calendar-day');
      const dateMap = new Map(calDays.map(d => [d.date, d]));

      // Clear all filter classes + trend arrows
      cells.forEach(c => {
        c.classList.remove('filter-dim', 'filter-highlight');
        const trend = c.querySelector('.day-trend');
        if (trend) trend.remove();
      });

      if (!calendarFilter) {
        renderCalendarTrends(calDays); // reset to default trends
        return;
      }

      // Build sets of highlighted dates
      const highlights = new Set();

      if (calendarFilter === 'health') {
        // Highlight danger + late night days
        calDays.forEach(d => {
          if (d.danger || d.lateNight) highlights.add(d.date);
        });
      } else if (calendarFilter === 'night') {
        calDays.forEach(d => {
          if (d.lateNight) highlights.add(d.date);
        });
      } else if (calendarFilter === 'streak') {
        // Highlight consecutive work days (streaks of 3+)
        let streak = [];
        for (const d of calDays) {
          if (d.sessions > 0) {
            streak.push(d.date);
          } else {
            if (streak.length >= 3) streak.forEach(s => highlights.add(s));
            streak = [];
          }
        }
        if (streak.length >= 3) streak.forEach(s => highlights.add(s));
      } else if (calendarFilter === 'trend') {
        // All active days get trend arrows (week-over-week comparison)
        calDays.forEach(d => { if (d.sessions > 0) highlights.add(d.date); });
      }

      // Apply dim/highlight
      cells.forEach(c => {
        const date = c.dataset?.date;
        if (!date) return;
        if (c.classList.contains('empty')) return;
        const d = dateMap.get(date);
        if (!d || d.sessions === 0) { c.classList.add('filter-dim'); return; }
        if (highlights.has(date)) {
          c.classList.add('filter-highlight');
        } else {
          c.classList.add('filter-dim');
        }
      });

      // For trend filter, add week-over-week arrows
      if (calendarFilter === 'trend') {
        cells.forEach(c => {
          const date = c.dataset?.date;
          if (!date || c.classList.contains('empty')) return;
          const d = dateMap.get(date);
          if (!d || d.sessions === 0) return;
          // Find same weekday last week
          const dt = new Date(date + 'T12:00:00');
          dt.setDate(dt.getDate() - 7);
          const prevDate = dt.toISOString().slice(0, 10);
          const prev = dateMap.get(prevDate);
          if (!prev) return;
          const curVal = d.sessions, prevVal = prev.sessions;
          let arrow = '', cls = 'flat';
          if (curVal > prevVal) { arrow = '^'; cls = 'up'; }
          else if (curVal < prevVal) { arrow = 'v'; cls = 'down'; }
          if (arrow) {
            const span = document.createElement('span');
            span.className = `day-trend ${cls}`;
            span.textContent = arrow;
            c.appendChild(span);
          }
        });
      }

      // Update trend strip to match filter context
      renderCalendarTrends(calDays);
    }

    // --- Calendar Trend Summary ---
    function renderCalendarTrends(calDays) {
      const container = document.getElementById('calendar-trends');
      if (!container || !calDays || calDays.length === 0) return;

      const activeDays = calDays.filter(d => d.sessions > 0);
      const totalDays = calDays.length;
      const restDays = totalDays - activeDays.length;

      // Streaks
      let maxStreak = 0, curStreak = 0, maxRest = 0, curRest = 0;
      for (const d of calDays) {
        if (d.sessions > 0) {
          curStreak++; maxStreak = Math.max(maxStreak, curStreak);
          if (curRest > 0) { maxRest = Math.max(maxRest, curRest); curRest = 0; }
        } else {
          curRest++; maxRest = Math.max(maxRest, curRest);
          if (curStreak > 0) { curStreak = 0; }
        }
      }

      // Night work frequency
      const nightDays = calDays.filter(d => d.lateNight).length;
      const heavyDays = calDays.filter(d => d.danger).length;

      // Week-over-week: last 7 active days vs prior 7
      const last7 = calDays.slice(-7);
      const prev7 = calDays.slice(-14, -7);
      const last7Sessions = last7.reduce((s, d) => s + d.sessions, 0);
      const prev7Sessions = prev7.reduce((s, d) => s + d.sessions, 0);
      const wowChange = prev7Sessions > 0 ? ((last7Sessions - prev7Sessions) / prev7Sessions * 100).toFixed(0) : 0;
      const wowDir = last7Sessions > prev7Sessions ? 'up' : last7Sessions < prev7Sessions ? 'down' : '';
      const wowArrow = wowDir === 'up' ? '^' : wowDir === 'down' ? 'v' : '-';

      // Avg sessions per active day
      const avgPerDay = activeDays.length > 0 ? (activeDays.reduce((s, d) => s + d.sessions, 0) / activeDays.length).toFixed(1) : '0';

      // Build chips based on active filter
      let chips = '';

      if (calendarFilter === 'health') {
        chips += chip('Heavy days', heavyDays + ' / ' + totalDays, heavyDays > 5 ? 'up' : '');
        chips += chip('Night work', nightDays + ' days', nightDays > 7 ? 'up' : '');
        chips += chip('Max streak', maxStreak + ' days', maxStreak > 10 ? 'up' : '');
        chips += chip('Max rest', maxRest + ' days', maxRest < 2 ? 'up' : 'down');
        // Health verdict
        const score = Math.max(0, 100 - heavyDays * 5 - nightDays * 3 - Math.max(0, maxStreak - 7) * 4);
        chips += chip('Health score', score + '/100', score < 50 ? 'up' : 'down');
      } else if (calendarFilter === 'night') {
        chips += chip('Late nights', nightDays + ' / ' + totalDays);
        const nightPct = totalDays > 0 ? (nightDays / totalDays * 100).toFixed(0) : 0;
        chips += chip('Night %', nightPct + '%', nightPct > 30 ? 'up' : '');
        // Night trend: last 30 vs first 30
        const half = Math.floor(calDays.length / 2);
        const firstHalfNights = calDays.slice(0, half).filter(d => d.lateNight).length;
        const secondHalfNights = calDays.slice(half).filter(d => d.lateNight).length;
        const nightTrend = secondHalfNights > firstHalfNights ? 'Increasing' : secondHalfNights < firstHalfNights ? 'Decreasing' : 'Stable';
        chips += chip('Night trend', nightTrend, secondHalfNights > firstHalfNights ? 'up' : 'down');
      } else if (calendarFilter === 'streak') {
        chips += chip('Longest streak', maxStreak + ' days');
        chips += chip('Longest rest', maxRest + ' days');
        chips += chip('Active days', activeDays.length + ' / ' + totalDays);
        chips += chip('Avg/active day', avgPerDay + ' sessions');
      } else if (calendarFilter === 'trend') {
        chips += chip('This week', last7Sessions + ' sessions');
        chips += chip('Last week', prev7Sessions + ' sessions');
        chips += chip('Week change', (wowChange > 0 ? '+' : '') + wowChange + '%', wowDir);
        chips += chip('Avg/day', avgPerDay + ' sessions');
      } else {
        // Default: compact overview
        chips += chip('Active', activeDays.length + '/' + totalDays + ' days');
        chips += chip('WoW', (wowChange > 0 ? '+' : '') + wowChange + '%', wowDir);
        chips += chip('Streak', maxStreak + 'd');
        chips += chip('Night', nightDays + 'd', nightDays > 7 ? 'up' : '');
        if (heavyDays > 0) chips += chip('Heavy', heavyDays + 'd', 'up');
      }

      container.innerHTML = chips;

      function chip(label, value, arrowDir) {
        const arrow = arrowDir === 'up' ? '<span class="trend-arrow up">^</span>'
                    : arrowDir === 'down' ? '<span class="trend-arrow down">v</span>' : '';
        return `<span class="trend-chip"><span class="trend-label">${label}</span><span class="trend-value">${value}</span>${arrow}</span>`;
      }
    }

    // --- Calendar Export ---
    document.getElementById('calendar-export-csv')?.addEventListener('click', () => exportCalendar('csv'));
    document.getElementById('calendar-export-md')?.addEventListener('click', () => exportCalendar('md'));

    function exportCalendar(format) {
      const calDays = state.stats?.calendar_days;
      if (!calDays || calDays.length === 0) return;

      const headers = ['Date', 'Day', 'Sessions', 'Duration (min)', 'Projects', 'Cost ($)', 'Lines Added', 'Late Night', 'Heavy Day'];
      const rows = calDays.map(d => {
        const dt = new Date(d.date + 'T12:00:00');
        const dayName = dt.toLocaleDateString('en-US', { weekday: 'short' });
        return [d.date, dayName, d.sessions, d.duration, d.projects, d.cost.toFixed(2), d.linesAdded, d.lateNight ? 'Yes' : '', d.danger ? 'Yes' : ''];
      });

      let content, filename, mime;

      if (format === 'csv') {
        content = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        filename = `calendar-${calendarMode}-${new Date().toISOString().slice(0, 10)}.csv`;
        mime = 'text/csv';
      } else {
        // Markdown table
        const colWidths = headers.map((h, i) => Math.max(h.length, ...rows.map(r => String(r[i]).length)));
        const pad = (s, w) => String(s).padEnd(w);
        const headerLine = '| ' + headers.map((h, i) => pad(h, colWidths[i])).join(' | ') + ' |';
        const sepLine = '| ' + colWidths.map(w => '-'.repeat(w)).join(' | ') + ' |';
        const bodyLines = rows.map(r => '| ' + r.map((c, i) => pad(c, colWidths[i])).join(' | ') + ' |');

        // Add summary at top
        const activeDays = calDays.filter(d => d.sessions > 0);
        const totalSessions = calDays.reduce((s, d) => s + d.sessions, 0);
        const totalCost = calDays.reduce((s, d) => s + d.cost, 0);
        const nightDays = calDays.filter(d => d.lateNight).length;

        content = `# Session Calendar Export\n\n`;
        content += `**Period:** ${calDays[0].date} to ${calDays[calDays.length - 1].date}\n`;
        content += `**Mode:** ${calendarMode}\n`;
        content += `**Active days:** ${activeDays.length}/${calDays.length} | **Sessions:** ${totalSessions} | **Cost:** $${totalCost.toFixed(2)} | **Late nights:** ${nightDays}\n\n`;
        content += [headerLine, sepLine, ...bodyLines].join('\n') + '\n';
        filename = `calendar-${calendarMode}-${new Date().toISOString().slice(0, 10)}.md`;
        mime = 'text/markdown';
      }

      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Wellbeing Strip ---
    function renderWellbeingStrip() {
      const wb = state.stats?.wellbeing;
      if (!wb) return;

      const strip = document.getElementById('wellbeing-strip');
      strip.style.display = '';

      const breakClass = wb.avg_break_minutes < 5 ? 'danger' : wb.avg_break_minutes < 15 ? 'warn' : 'good';
      const streakClass = wb.current_streak_days > 10 ? 'danger' : wb.current_streak_days > 5 ? 'warn' : 'good';
      const lateClass = wb.late_night_days > 10 ? 'danger' : wb.late_night_days > 3 ? 'warn' : 'good';
      const weekendClass = wb.weekend_work_days > 4 ? 'warn' : 'good';

      strip.innerHTML = `
        <div class="wellbeing-metric">
          <span class="wb-label">Avg Break</span>
          <span class="wb-value ${breakClass}">${wb.avg_break_minutes}m</span>
        </div>
        <div class="wellbeing-metric">
          <span class="wb-label">Streak</span>
          <span class="wb-value ${streakClass}">${wb.current_streak_days}d</span>
        </div>
        <div class="wellbeing-metric">
          <span class="wb-label">Late Nights</span>
          <span class="wb-value ${lateClass}">${wb.late_night_days}</span>
        </div>
        <div class="wellbeing-metric">
          <span class="wb-label">Weekend Work</span>
          <span class="wb-value ${weekendClass}">${wb.weekend_work_days}d</span>
        </div>
        <div class="wellbeing-metric">
          <span class="wb-label">Danger Days</span>
          <span class="wb-value ${wb.danger_days.length > 3 ? 'danger' : wb.danger_days.length > 0 ? 'warn' : 'good'}">${wb.danger_days.length}</span>
        </div>
      `;
    }

    function renderChart() {
      const container = document.getElementById('daily-chart');
      const datesContainer = document.getElementById('chart-dates');
      const dailyData = state.dailyData;
      if (!dailyData || dailyData.length === 0) return;

      let bars = []; // [{key, count, label}]

      if (state.granularity === 'day') {
        // Aggregate daily data into monthly buckets
        const monthMap = new Map();
        for (const [date, count] of dailyData) {
          const monthKey = date.slice(0, 7); // YYYY-MM
          monthMap.set(monthKey, (monthMap.get(monthKey) || 0) + count);
        }
        const sorted = [...monthMap.entries()].sort((a, b) => a[0].localeCompare(b[0]));
        const recent = sorted.slice(-12); // last 12 months
        for (const [monthKey, count] of recent) {
          const d = new Date(monthKey + '-15T12:00:00');
          const label = d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          bars.push({ key: monthKey, count, label: `${label}: ${count}` });
        }
      } else if (state.granularity === 'month') {
        // Daily bars (last 60 days)
        const recent = dailyData.slice(-60);
        for (const [date, count] of recent) {
          bars.push({ key: date, count, label: `${date}: ${count} sessions` });
        }
      } else {
        // Week: aggregate daily data into weekly buckets
        const weekMap = new Map();
        for (const [date, count] of dailyData) {
          const d = new Date(date + 'T12:00:00');
          const day = d.getDay();
          const diff = d.getDate() - day + (day === 0 ? -6 : 1);
          const monday = new Date(d);
          monday.setDate(diff);
          const weekKey = monday.toISOString().slice(0, 10);
          weekMap.set(weekKey, (weekMap.get(weekKey) || 0) + count);
        }
        const sorted = [...weekMap.entries()].sort((a, b) => a[0].localeCompare(b[0]));
        const recent = sorted.slice(-26); // ~6 months of weeks
        for (const [weekKey, count] of recent) {
          const d = new Date(weekKey + 'T12:00:00');
          const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          bars.push({ key: weekKey, count, label: `Week of ${label}: ${count}` });
        }
      }

      const max = Math.max(...bars.map(b => b.count), 1);
      let barsHtml = '';
      for (let i = 0; i < bars.length; i++) {
        const b = bars[i];
        const h = (b.count / max * 100);
        const sel = state.dateFilter === b.key ? 'selected' : '';
        const dim = state.dateFilter && state.dateFilter !== b.key ? 'dimmed' : '';
        barsHtml += `<div class="chart-bar ${sel} ${dim}" style="height:${h}%;--i:${i}" data-date="${b.key}" data-tooltip="${b.label}"></div>`;
      }
      container.innerHTML = barsHtml;

      // Date labels
      if (bars.length > 0) {
        const first = bars[0].key.slice(5);
        const last = bars[bars.length - 1].key.slice(5);
        datesContainer.innerHTML = `<span>${first}</span><span>${last}</span>`;
      }
    }

    // Event delegation for chart bar clicks
    document.getElementById('daily-chart').addEventListener('click', (e) => {
      const bar = e.target.closest('.chart-bar');
      if (!bar) return;
      const date = bar.dataset.date;
      if (state.granularity === 'day') return; // monthly bars aren't date-filterable
      if (state.dateFilter === date) {
        clearDateFilter();
      } else {
        setDateFilter(date);
      }
    });

    function setDateFilter(date) {
      state.dateFilter = date;
      state.page = 1;
      state.expandedGroups.clear();
      // Show filter bar
      const filterBar = document.getElementById('date-filter-bar');
      const filterLabel = document.getElementById('date-filter-label');
      filterBar.classList.add('visible');
      const d = new Date(date + 'T12:00:00');
      filterLabel.textContent = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      // Re-render chart with selection state
      renderChart();
      // Reload with date filter then scroll to sessions
      loadSessions(1, date).then(() => {
        document.getElementById('session-list')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    function clearDateFilter() {
      state.dateFilter = null;
      state.expandedGroups.clear();
      document.getElementById('date-filter-bar').classList.remove('visible');
      renderChart();
      loadSessions(1);
    }

    document.getElementById('date-filter-clear').addEventListener('click', clearDateFilter);

    // --- Load Sessions ---
    async function loadSessions(page = 1, dateFilter = null) {
      try {
        let url = `/api/sessions?page=${page}&limit=200`;
        if (dateFilter) url += `&date=${dateFilter}`;
        const res = await safeFetch(url);
        const data = await res.json();
        state.allSessions = data.sessions;
        state.page = data.page;
        state.totalPages = data.pages;

        // Generate smart filters from loaded sessions
        generateSmartFilters(data.sessions);

        // Re-render chart (Day view uses session times for hourly bars)
        if (state.dailyData) renderChart();

        // Apply current find/filter then render
        applyFiltersAndRender();

        document.getElementById('page-info').textContent = `${data.page} / ${data.pages}`;
        document.getElementById('prev-page').disabled = data.page <= 1;
        document.getElementById('next-page').disabled = data.page >= data.pages;
      } catch (e) {
        console.error('Failed to load sessions:', e);
        document.getElementById('session-list').innerHTML = `<div style="padding:20px;color:var(--c-brand);">${e.name === 'AbortError' ? 'Request timed out. Server may be slow.' : 'Failed to load sessions. Check server connection.'}</div>`;
      }
    }

    // --- Smart Filters ---
    function generateSmartFilters(sessions) {
      const projectCounts = {};
      const classCounts = {};

      for (const s of sessions) {
        const proj = shortProject(s.project);
        if (proj) projectCounts[proj] = (projectCounts[proj] || 0) + 1;

        // Classify each session
        const tags = classifySession(s);
        s._tags = tags; // cache for filtering
        for (const tag of tags) {
          classCounts[tag] = (classCounts[tag] || 0) + 1;
        }
      }

      // Project filters (top 6)
      const projectFilters = Object.entries(projectCounts)
        .filter(([, c]) => c > 1)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6)
        .map(([proj, count]) => ({ label: proj.split('/').pop(), key: `project:${proj}`, count }));

      // Classification filters
      const classLabels = {
        large: 'Large', medium: 'Medium', quick: 'Quick',
        strategic: 'Strategic', tactical: 'Tactical', mechanical: 'Mechanical',
        coding: 'Coding', research: 'Research', errors: 'Has Errors', interactive: 'Interactive'
      };
      const classFilters = Object.entries(classLabels)
        .filter(([k]) => (classCounts[k] || 0) > 0)
        .map(([k, label]) => ({ label, key: `class:${k}`, count: classCounts[k] || 0 }));

      state.smartFilters = [...projectFilters, ...classFilters];
      renderSmartFilters();
    }

    function renderSmartFilters() {
      const container = document.getElementById('smart-filters');
      let html = '';
      for (const f of state.smartFilters) {
        const active = state.activeFilters.has(f.key) ? 'active' : '';
        html += `<button class="smart-filter ${active}" data-filter-key="${escapeHtml(f.key)}">${escapeHtml(f.label)}<span class="filter-count">${f.count}</span></button>`;
      }
      if (state.activeFilters.size > 0) {
        html += `<button class="smart-filter" data-filter-key="__clear__" style="border-color:var(--c-brand);color:var(--c-brand)">Clear all</button>`;
      }
      container.innerHTML = html;

      container.querySelectorAll('.smart-filter').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.filterKey;
          if (key === '__clear__') {
            state.activeFilters.clear();
          } else if (state.activeFilters.has(key)) {
            state.activeFilters.delete(key);
          } else {
            state.activeFilters.add(key);
          }
          state.expandedGroups.clear();
          renderSmartFilters();
          applyFiltersAndRender();
        });
      });
    }

    // --- Find + Filter ---
    function applyFiltersAndRender() {
      let filtered = state.allSessions;

      // Text search
      if (state.findQuery) {
        const q = state.findQuery.toLowerCase();
        filtered = filtered.filter(s =>
          (s.summary || '').toLowerCase().includes(q) ||
          (s.first_prompt || '').toLowerCase().includes(q) ||
          (s.project || '').toLowerCase().includes(q) ||
          s.session_id.includes(q)
        );
      }

      // Smart filters (multi-select: session must match ALL active filters)
      if (state.activeFilters.size > 0) {
        for (const key of state.activeFilters) {
          if (key.startsWith('project:')) {
            const proj = key.slice(8);
            filtered = filtered.filter(s => shortProject(s.project) === proj);
          } else if (key.startsWith('class:')) {
            const cls = key.slice(6);
            filtered = filtered.filter(s => (s._tags || []).includes(cls));
          }
        }
      }

      state.sessions = filtered;
      renderGroupedSessionList(filtered, 'recent-sessions');
    }

    // --- Find Input (debounced) ---
    let _findTimer = 0;
    document.getElementById('find-input').addEventListener('input', (e) => {
      clearTimeout(_findTimer);
      _findTimer = setTimeout(() => {
        state.findQuery = e.target.value.trim();
        state.expandedGroups.clear();
        applyFiltersAndRender();
      }, 150);
    });

    // --- Time Period Grouping ---
    function getTimePeriodKey(iso, granularity) {
      if (!iso) return 'unknown';
      const d = new Date(iso);
      if (granularity === 'day') {
        return iso.slice(0, 10);
      } else if (granularity === 'week') {
        // ISO week: find Monday of this week
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(d);
        monday.setDate(diff);
        return monday.toISOString().slice(0, 10);
      } else { // month
        return iso.slice(0, 7);
      }
    }

    function formatPeriodHeader(key, granularity, count) {
      if (granularity === 'day') {
        const d = new Date(key + 'T12:00:00');
        const today = new Date().toISOString().slice(0, 10);
        const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
        if (key === today) return 'Today';
        if (key === yesterday) return 'Yesterday';
        return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
      } else if (granularity === 'week') {
        const monday = new Date(key + 'T12:00:00');
        const sunday = new Date(monday);
        sunday.setDate(sunday.getDate() + 6);
        // Check if this is current week
        const now = new Date();
        const nowKey = getTimePeriodKey(now.toISOString(), 'week');
        if (key === nowKey) return 'This Week';
        const lastWeek = new Date(now);
        lastWeek.setDate(lastWeek.getDate() - 7);
        const lastWeekKey = getTimePeriodKey(lastWeek.toISOString(), 'week');
        if (key === lastWeekKey) return 'Last Week';
        return monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' -- ' +
               sunday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      } else { // month
        const d = new Date(key + '-15T12:00:00');
        const nowMonth = new Date().toISOString().slice(0, 7);
        if (key === nowMonth) return 'This Month';
        return d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      }
    }

    function groupByTimePeriod(sessions, granularity) {
      const periods = [];
      const periodMap = new Map();

      for (const s of sessions) {
        const key = getTimePeriodKey(s.start_time, granularity);
        if (periodMap.has(key)) {
          periodMap.get(key).sessions.push(s);
        } else {
          const period = { key, sessions: [s] };
          periodMap.set(key, period);
          periods.push(period);
        }
      }
      return periods;
    }

    // --- Similarity grouping within time periods ---
    const _simKeyCache = new Map();
    function getSimilarityKey(s) {
      const id = s.session_id;
      if (_simKeyCache.has(id)) return _simKeyCache.get(id);
      let sig = (s.summary || s.first_prompt || '').toLowerCase().trim();
      sig = sig.replace(/\[?\{[^}]*\}]?/g, '').trim();
      sig = sig.replace(/[0-9a-f]{8}-[0-9a-f]{4}/g, '').trim();
      sig = sig.replace(/\d{4,}/g, '').trim();
      sig = sig.replace(/\s+/g, ' ');
      const project = shortProject(s.project);
      const key = `${project}|${sig.slice(0, 50)}`;
      _simKeyCache.set(id, key);
      return key;
    }

    function collapseSimilarSessions(sessions) {
      const result = [];
      const groupMap = new Map();

      for (const s of sessions) {
        const key = getSimilarityKey(s);
        if (groupMap.has(key)) {
          groupMap.get(key).items.push(s);
        } else {
          const group = { key, items: [s] };
          groupMap.set(key, group);
          result.push(group);
        }
      }
      return result;
    }

    // --- Match preview with highlighted keyword ---
    function getMatchPreview(session, query) {
      if (!query) return '';
      const q = query.toLowerCase();
      // Search fields in priority order with labels
      const fields = [
        { text: session.first_prompt, label: 'prompt' },
        { text: session.summary, label: 'summary' },
        { text: session.project, label: 'project' },
      ];
      for (const { text, label } of fields) {
        if (!text) continue;
        const idx = text.toLowerCase().indexOf(q);
        if (idx === -1) continue;
        // Extract snippet: ~40 chars before, match, ~60 chars after
        const start = Math.max(0, idx - 40);
        const end = Math.min(text.length, idx + query.length + 60);
        let snippet = text.slice(start, end).replace(/\n/g, ' ');
        if (start > 0) snippet = '...' + snippet;
        if (end < text.length) snippet += '...';
        // Highlight the match (escape first, then insert <mark>)
        const escaped = escapeHtml(snippet);
        const matchStart = escapeHtml(snippet.slice(0, idx - start + (start > 0 ? 3 : 0)));
        // Simpler: use regex on escaped string
        const re = new RegExp('(' + escapeHtml(query).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
        const highlighted = escaped.replace(re, '<mark>$1</mark>');
        return `<span class="match-preview"><span class="match-source">${label}</span>${highlighted}</span>`;
      }
      return '';
    }

    // --- Session Badges ---
    function renderSessionBadges(s) {
      let badges = '';
      // Cost
      if (s.estimated_cost > 0) {
        badges += `<span class="badge badge-cost">$${s.estimated_cost < 0.01 ? '<0.01' : s.estimated_cost.toFixed(2)}</span>`;
      }
      // Error dot
      if (s.tool_errors > 0) {
        badges += `<span class="badge badge-error" title="${s.tool_errors} errors">${s.tool_errors}err</span>`;
      }
      // Top 2 languages as tiny pills
      if (s.languages) {
        const langs = Object.entries(s.languages).sort((a, b) => b[1] - a[1]).slice(0, 2);
        for (const [lang] of langs) {
          const short = lang.length > 3 ? lang.slice(0, 3) : lang;
          badges += `<span class="badge badge-lang">${escapeHtml(short)}</span>`;
        }
      }
      // Task agent badge
      if (s.uses_task_agent) {
        badges += `<span class="badge badge-task" title="Uses Task agent">T</span>`;
      }
      // Lines delta
      const linesDelta = (s.lines_added || 0) - (s.lines_removed || 0);
      if (linesDelta !== 0) {
        const cls = linesDelta > 0 ? 'badge-lines' : 'badge-lines negative';
        badges += `<span class="badge ${cls}">${linesDelta > 0 ? '+' : ''}${linesDelta}</span>`;
      }
      return badges ? `<span class="session-badges">${badges}</span>` : '';
    }

    // --- Session Classification ---
    function classifySession(s) {
      const totalTokens = (s.input_tokens || 0) + (s.output_tokens || 0);
      const duration = s.duration_minutes || 0;
      const toolCount = Object.values(s.tool_counts || {}).reduce((sum, c) => sum + c, 0);
      const hasErrors = (s.tool_errors || 0) > 0;
      const linesChanged = (s.lines_added || 0) + (s.lines_removed || 0);

      const tags = [];

      // Size classification
      if (totalTokens > 500000 || duration > 60) tags.push('large');
      else if (totalTokens > 100000 || duration > 15) tags.push('medium');
      else if (totalTokens < 20000 && duration < 5) tags.push('quick');
      else tags.push('small');

      // Value/semantic classification
      if (s.uses_task_agent || toolCount > 30 || linesChanged > 200) tags.push('strategic');
      else if (toolCount > 10 || linesChanged > 50) tags.push('tactical');
      else tags.push('mechanical');

      // Nature
      if (linesChanged > 100 || (s.git_commits || 0) > 0) tags.push('coding');
      if (s.uses_web_search) tags.push('research');
      if (hasErrors) tags.push('errors');
      if ((s.user_messages || 0) > 5) tags.push('interactive');

      return tags;
    }

    // --- Render Grouped Session List ---
    function renderGroupedSessionList(sessions, containerId) {
      const container = document.getElementById(containerId);
      const periods = groupByTimePeriod(sessions, state.granularity);
      let html = '';

      for (const period of periods) {
        const headerText = formatPeriodHeader(period.key, state.granularity, period.sessions.length);
        html += `<div class="time-group-header">
          <span>${escapeHtml(headerText)}</span>
          <span class="count">${period.sessions.length} session${period.sessions.length !== 1 ? 's' : ''}</span>
        </div>`;

        const collapsed = collapseSimilarSessions(period.sessions);

        for (const group of collapsed) {
          if (group.items.length === 1) {
            const s = group.items[0];
            const totalTokens = (s.input_tokens || 0) + (s.output_tokens || 0);
            const preview = getMatchPreview(s, state.findQuery);
            html += `<div class="session-row" data-session-id="${s.session_id}">
              <span class="session-time">${formatDate(s.start_time)}</span>
              <span class="session-summary">${escapeHtml(s.summary || s.first_prompt || s.session_id)}${preview}</span>
              ${renderSessionBadges(s)}
              <span class="session-project">${escapeHtml(shortProject(s.project))}</span>
              <span class="session-tokens">${formatTokens(totalTokens)}</span>
            </div>`;
          } else {
            // Collapsed group row
            const first = group.items[0];
            const last = group.items[group.items.length - 1];
            const totalTokens = group.items.reduce((sum, s) => sum + (s.input_tokens || 0) + (s.output_tokens || 0), 0);
            const isExpanded = state.expandedGroups.has(group.key);
            const timeStr = formatTime(last.start_time) + ' - ' + formatTime(first.start_time);
            const label = first.summary || first.first_prompt || first.session_id;
            // Truncate long JSON-heavy labels
            const shortLabel = label.length > 60 ? label.slice(0, 57) + '...' : label;

            html += `<div class="session-group-row" data-group-key="${escapeHtml(group.key)}">
              <span class="session-time">${timeStr}</span>
              <span class="session-summary">
                <span class="group-badge">${group.items.length}x</span>
                ${escapeHtml(shortLabel)}
              </span>
              <span class="session-project">${escapeHtml(shortProject(first.project))}</span>
              <span class="session-tokens">${formatTokens(totalTokens)}</span>
            </div>`;

            if (isExpanded) {
              html += `<div class="group-expanded">`;
              for (const s of group.items) {
                const st = (s.input_tokens || 0) + (s.output_tokens || 0);
                const preview = getMatchPreview(s, state.findQuery);
                html += `<div class="session-row" data-session-id="${s.session_id}">
                  <span class="session-time">${formatTime(s.start_time)}</span>
                  <span class="session-summary">${escapeHtml(s.summary || s.first_prompt || s.session_id)}${preview}</span>
                  <span class="session-tokens">${formatTokens(st)}</span>
                </div>`;
              }
              html += '</div>';
            }
          }
        }
      }

      if (sessions.length === 0) {
        html = '<div style="padding: var(--space-md); color: var(--c-meta); font-style: italic;">No sessions match your search.</div>';
      }

      container.innerHTML = html;
      // Event delegation is set up once via setupSessionListDelegation()
    }

    // --- One-time event delegation for session lists ---
    function setupSessionListDelegation(containerId) {
      const container = document.getElementById(containerId);
      container.addEventListener('click', (e) => {
        // Session row click
        const row = e.target.closest('.session-row');
        if (row && row.dataset.sessionId) {
          e.stopPropagation();
          openSession(row.dataset.sessionId);
          return;
        }
        // Group row click (expand/collapse)
        const groupRow = e.target.closest('.session-group-row');
        if (groupRow && groupRow.dataset.groupKey) {
          const key = groupRow.dataset.groupKey;
          if (state.expandedGroups.has(key)) {
            state.expandedGroups.delete(key);
          } else {
            state.expandedGroups.add(key);
          }
          applyFiltersAndRender();
        }
      });
    }
    setupSessionListDelegation('recent-sessions');

    // --- Granularity Toggle ---
    document.querySelectorAll('.granularity-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        state.granularity = btn.dataset.granularity;
        document.querySelectorAll('.granularity-btn').forEach(b => b.classList.toggle('active', b === btn));
        state.expandedGroups.clear();
        renderChart();
        applyFiltersAndRender();
      });
    });

    function formatTime(iso) {
      if (!iso) return '--';
      const d = new Date(iso);
      return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    // Pagination
    document.getElementById('prev-page').addEventListener('click', () => loadSessions(state.page - 1, state.dateFilter));
    document.getElementById('next-page').addEventListener('click', () => loadSessions(state.page + 1, state.dateFilter));

    // --- Open Session Detail ---
    async function openSession(sessionId) {
      state.currentSessionId = sessionId;
      switchView('session');

      const meta = state.sessions.find(s => s.session_id === sessionId);

      // Render left panel meta
      const metaPanel = document.getElementById('session-meta-panel');
      if (meta) {
        const rows = [
          ['Project', shortProject(meta.project)],
          ['Started', formatDate(meta.start_time)],
          ['Duration', (meta.duration_minutes || 0) + ' min'],
          ['User Msgs', meta.user_messages],
          ['Asst Msgs', meta.assistant_messages],
          ['Tokens In', formatTokens(meta.input_tokens || 0)],
          ['Tokens Out', formatTokens(meta.output_tokens || 0)],
          ['Lines +/-', `+${meta.lines_added || 0} / -${meta.lines_removed || 0}`],
          ['Est. Cost', '$' + (meta.estimated_cost || 0).toFixed(2)],
          ['Errors', meta.tool_errors || 0],
        ];
        let html = '';
        for (const [k, v] of rows) {
          html += `<div class="meta-row"><span class="key">${k}</span><span>${v}</span></div>`;
        }
        // Tool counts
        if (meta.tool_counts) {
          html += '<div style="margin-top: var(--space-sm);">';
          for (const [tool, count] of Object.entries(meta.tool_counts).sort((a, b) => b[1] - a[1])) {
            html += `<div class="meta-row"><span class="key">${escapeHtml(tool)}</span><span>${count}</span></div>`;
          }
          html += '</div>';
        }
        // Resume button
        html += `<div style="margin-top: var(--space-md); padding: var(--space-sm) 0;">
          <code style="font-size: 11px; background: rgba(0,0,0,0.06); padding: 4px 8px; display: block;">claude --resume ${sessionId}</code>
        </div>`;
        metaPanel.innerHTML = html;
      }

      // Render right panel title
      document.getElementById('session-title').textContent =
        meta?.summary || meta?.first_prompt?.slice(0, 60) || sessionId;

      // Session action links (view/download raw)
      const detailContainer = document.getElementById('session-detail');
      detailContainer.classList.add('visible');

      const actionsHtml = `<div class="session-actions">
        <button class="session-action-link" onclick="viewRawSession('${sessionId}')">View raw transcript</button>
        <button class="session-action-link" onclick="downloadSession('${sessionId}')">Download session (.md)</button>
        <button class="session-action-link session-action-btn" id="session-gen-actions-btn" onclick="generateSessionActions('${sessionId}')">Generate Actionable</button>
        <button class="session-action-link" onclick="regenerateInsight('${sessionId}')" title="Clear cached insight and re-analyze">Regenerate</button>
      </div>`;

      // Check cache first
      const cached = state.insightsCache[sessionId];
      if (cached) {
        detailContainer.innerHTML = actionsHtml + `<div class="agent-response visible">${renderMarkdown(cached.text)}</div>`;
        addSuggestionInteractivity(detailContainer);
        if (cached.cost) {
          detailContainer.innerHTML += `<div class="cost-display">Agent cost: $${cached.cost.toFixed(4)} (${cached.turns} turns) (cached)</div>`;
        }
        detailContainer.dataset.rawText = cached.text;
        // Restore action cards if any
        if (cached.actions) {
          const actionsContainer = document.createElement('div');
          actionsContainer.className = 'action-cards';
          actionsContainer.id = 'session-action-cards';
          detailContainer.appendChild(actionsContainer);
          renderActionCards(cached.actions, actionsContainer);
        }
        return;
      }

      detailContainer.innerHTML = actionsHtml + '<div class="loading visible">Analyzing session</div>';

      // Ask agent for full structured detail
      try {
        const response = await streamAgent(
          `Get the detail for session ${sessionId}. Format your response as a well-structured document:

1. Start with a one-paragraph **Executive Summary** of what was accomplished.

2. **Key Metrics**  present as a markdown table with columns: Metric, Value. Include: total messages, user messages, assistant messages, tokens in/out, duration, lines changed, error count.

3. **Workflow Timeline**  describe the major phases of the session in order (what the user asked, what tools were used, what was produced). Use a numbered list.

4. **Tool Usage**  show a markdown table with columns: Tool, Count, Purpose. Include all tools used.

5. **Insights & Suggestions**  based on the session patterns, provide 2-4 actionable suggestions formatted as:
   ### Suggestion: [Title]
   **Why**: [One sentence explanation]
   **Prompt to try**: \`[A concrete prompt the user could use next time]\`
   **Apply to**: workflow | this project | all sessions

Keep it concise but thorough. Use markdown tables and headers for structure.`
        );

        // Cache the response
        state.insightsCache[sessionId] = { text: response.text, cost: response.cost, turns: response.turns };
        saveInsightsCache();

        // Render the response as a proper document
        detailContainer.innerHTML = actionsHtml + `<div class="agent-response visible">${renderMarkdown(response.text)}</div>`;

        // Add interactive suggestion cards directly on the live DOM
        addSuggestionInteractivity(detailContainer);
        if (response.cost) {
          detailContainer.innerHTML += `<div class="cost-display">Agent cost: $${response.cost.toFixed(4)} (${response.turns} turns)</div>`;
        }

        // Store raw text for download
        detailContainer.dataset.rawText = response.text;
      } catch (e) {
        detailContainer.innerHTML = actionsHtml + `<div style="color: var(--c-brand);">Error loading detail: ${escapeHtml(String(e))}</div>`;
      }
    }

    document.getElementById('back-to-list').addEventListener('click', () => switchView('overview'));

    // --- Regenerate insight (clear cache, re-fetch) ---
    async function regenerateInsight(sessionId) {
      delete state.insightsCache[sessionId];
      saveInsightsCache();
      await openSession(sessionId);
    }

    // --- Session download/view helpers ---

    async function viewRawSession(sessionId) {
      const detailContainer = document.getElementById('session-detail');
      // Toggle: if transcript already showing, switch back to summary
      if (detailContainer.dataset.showingTranscript === 'true') {
        detailContainer.dataset.showingTranscript = 'false';
        // Re-trigger openSession to show agent summary
        openSession(sessionId);
        return;
      }

      detailContainer.innerHTML = '<div class="loading visible">Loading transcript</div>';

      try {
        const res = await safeFetch(`/api/transcript/${sessionId}`, { timeout: 60000 });
        const data = await res.json();

        if (data.error) {
          detailContainer.innerHTML = `<div style="color: var(--c-brand);">Error: ${escapeHtml(data.error)}</div>`;
          return;
        }

        let html = `<div class="session-actions">
          <button class="session-action-link active" onclick="viewRawSession('${sessionId}')">Transcript</button>
          <button class="session-action-link" onclick="openSession('${sessionId}')">Agent Summary</button>
          <button class="session-action-link" onclick="downloadSession('${sessionId}')">Download .md</button>
        </div>`;

        html += '<div class="transcript">';
        let msgIdx = 0;
        for (const msg of data.messages) {
          if (!msg.content && msg.tools.length === 0) continue;
          const timeStr = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }) : '';

          html += `<div class="transcript-msg" style="--msg-i:${msgIdx++}">
            <div class="transcript-role ${msg.role}">${msg.role}${timeStr ? `<span class="transcript-time">${timeStr}</span>` : ''}</div>`;

          if (msg.content) {
            html += `<div class="transcript-text">${renderMarkdown(msg.content)}</div>`;
          }

          if (msg.tools.length > 0) {
            html += '<div class="transcript-tools">';
            for (const t of msg.tools) {
              const errClass = t.isError ? 'error' : '';
              html += `<span class="transcript-tool ${errClass}">${escapeHtml(t.name)}</span>`;
            }
            html += '</div>';
          }

          html += '</div>';
        }
        html += '</div>';

        detailContainer.innerHTML = html;
        detailContainer.dataset.showingTranscript = 'true';

        // Store transcript for download
        const mdText = data.messages
          .filter(m => m.content)
          .map(m => `## ${m.role}\n\n${m.content}`)
          .join('\n\n---\n\n');
        detailContainer.dataset.rawText = mdText;
      } catch (e) {
        detailContainer.innerHTML = `<div style="color: var(--c-brand);">Error: ${escapeHtml(String(e))}</div>`;
      }
    }

    function downloadSession(sessionId) {
      const detailContainer = document.getElementById('session-detail');
      const raw = detailContainer.dataset.rawText;
      if (!raw) return;
      const blob = new Blob([`# Session: ${sessionId}\n\n${raw}`], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `session-${sessionId.slice(0, 8)}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function addSuggestionInteractivity(containerEl) {
      // Mark code elements that look like prompts directly on the live DOM (no double-serialization)
      containerEl.querySelectorAll('code').forEach(code => {
        const text = code.textContent;
        if (text.length > 15 && /^[A-Z]/.test(text)) {
          code.classList.add('copyable-prompt');
          code.style.cursor = 'pointer';
          code.title = 'Click to copy this prompt';
          code.dataset.copyText = text;
        }
      });
    }

    // Event delegation for copyable prompts
    document.getElementById('session-detail').addEventListener('click', (e) => {
      const code = e.target.closest('.copyable-prompt');
      if (!code || !code.dataset.copyText) return;
      const text = code.dataset.copyText;
      navigator.clipboard.writeText(text).then(() => {
        const original = code.textContent;
        code.textContent = 'Copied!';
        code.style.color = 'var(--c-brand)';
        setTimeout(() => {
          code.textContent = original;
          code.style.color = '';
        }, 1500);
      });
    });

    // --- Per-session actionable insights ---
    async function generateSessionActions(sessionId) {
      const btn = document.getElementById('session-gen-actions-btn');
      if (btn) { btn.disabled = true; btn.textContent = 'Analyzing...'; }

      const detailContainer = document.getElementById('session-detail');
      let cardsEl = document.getElementById('session-action-cards');
      if (!cardsEl) {
        cardsEl = document.createElement('div');
        cardsEl.className = 'action-cards';
        cardsEl.id = 'session-action-cards';
        detailContainer.appendChild(cardsEl);
      }
      cardsEl.innerHTML = '<div class="loading visible">Generating actionable insights for this session</div>';

      try {
        const meta = state.sessions.find(s => s.session_id === sessionId);
        const focus = meta ? `session in project ${meta.project || 'unknown'}, summary: ${meta.summary || meta.first_prompt || ''}` : `session ${sessionId}`;
        const res = await safeFetch('/api/actions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ focus: `Analyze this specific ${focus}. Session ID: ${sessionId}` }),
          timeout: 120000,
        });
        const data = await res.json();

        if (data.actions && data.actions.length > 0) {
          cardsEl.innerHTML = '';
          renderActionCards(data.actions, cardsEl);
          // Cache the actions alongside existing insights
          if (state.insightsCache[sessionId]) {
            state.insightsCache[sessionId].actions = data.actions;
            saveInsightsCache();
          }
        } else {
          cardsEl.innerHTML = '<p style="padding: var(--space-sm); opacity: 0.6;">No actionable insights generated for this session.</p>';
        }
      } catch (e) {
        cardsEl.innerHTML = `<p style="color: var(--c-brand); padding: var(--space-sm);">Error: ${escapeHtml(String(e))}</p>`;
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'Generate Actionable'; }
      }
    }

    // --- Search ---
    document.querySelectorAll('.filter-tag').forEach(tag => {
      tag.addEventListener('click', () => {
        document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
        tag.classList.add('active');
        state.searchMode = tag.dataset.mode;
      });
    });

    document.getElementById('search-btn').addEventListener('click', doSearch);
    document.getElementById('search-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') doSearch();
    });

    async function doSearch() {
      const query = document.getElementById('search-input').value.trim();
      if (!query) return;

      const btn = document.getElementById('search-btn');
      btn.disabled = true;

      const loading = document.getElementById('search-loading');
      const responseEl = document.getElementById('search-response');
      const resultsEl = document.getElementById('search-results');
      loading.classList.add('visible');
      responseEl.classList.remove('visible');
      responseEl.textContent = '';
      resultsEl.innerHTML = '';

      if (state.searchMode === 'text') {
        // Direct REST search
        try {
          const res = await safeFetch(`/api/sessions?search=${encodeURIComponent(query)}&limit=50`);
          const data = await res.json();
          loading.classList.remove('visible');
          renderGroupedSessionList(data.sessions, 'search-results');
          responseEl.textContent = `Found ${data.total} sessions matching "${query}"`;
          responseEl.classList.add('visible');
        } catch (e) {
          loading.classList.remove('visible');
          responseEl.textContent = `Error: ${e}`;
          responseEl.classList.add('visible');
        }
      } else {
        // Semantic search via agent
        const agentStatus = document.getElementById('agent-status');
        agentStatus.classList.add('active');
        document.getElementById('agent-tool-calls').innerHTML = '';

        try {
          const response = await streamAgent(
            `Search for sessions matching: "${query}". Use the search_sessions tool for semantic search. Then summarize what you found.`,
            (event) => {
              if (event.type === 'tool_use') {
                const callsEl = document.getElementById('agent-tool-calls');
                callsEl.innerHTML += `<div class="agent-tool-call">${escapeHtml(event.tool)}(${JSON.stringify(event.input).slice(0, 80)})</div>`;
              }
            }
          );
          loading.classList.remove('visible');
          responseEl.innerHTML = renderMarkdown(response.text);
          responseEl.classList.add('visible');
          if (response.cost) {
            responseEl.innerHTML += `<div class="cost-display">Agent cost: $${response.cost.toFixed(4)} (${response.turns} turns)</div>`;
          }
        } catch (e) {
          loading.classList.remove('visible');
          responseEl.textContent = `Error: ${e}`;
          responseEl.classList.add('visible');
        }
        agentStatus.classList.remove('active');
      }
      btn.disabled = false;
    }

    // --- Insights ---
    document.querySelectorAll('.insights-nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const action = item.dataset.action;
        if (action === 'load-report') loadInsightsReport();
      });
    });

    document.getElementById('insights-ask-btn').addEventListener('click', askInsightsAgent);
    document.getElementById('insights-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') askInsightsAgent();
    });

    // Suggestion presets toggle
    document.getElementById('suggestions-toggle').addEventListener('click', () => {
      const presets = document.getElementById('insight-presets');
      presets.style.display = presets.style.display === 'none' ? '' : 'none';
    });

    // Preset buttons
    document.querySelectorAll('.insight-preset').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('insights-input').value = btn.dataset.q;
        askInsightsAgent();
      });
    });

    // --- Report list management (localStorage-persisted) ---
    const REPORTS_KEY = 'session-explorer-reports';
    let reportCounter = 0;

    function saveReportsToStorage() {
      const cards = document.querySelectorAll('.report-card');
      const reports = [];
      cards.forEach(card => {
        reports.push({
          title: card.querySelector('.report-card-title').textContent,
          html: card.querySelector('.report-card-body').innerHTML,
          time: card.querySelector('.report-card-time').textContent,
          ts: card.dataset.ts || Date.now(),
        });
      });
      try { localStorage.setItem(REPORTS_KEY, JSON.stringify(reports)); } catch {}
    }

    function loadReportsFromStorage() {
      try {
        const data = JSON.parse(localStorage.getItem(REPORTS_KEY) || '[]');
        if (!Array.isArray(data) || data.length === 0) return;
        // Load oldest first so prepend order results in newest on top
        for (let i = data.length - 1; i >= 0; i--) {
          const r = data[i];
          createReportCardDOM(r.title, r.html, r.time, r.ts, false);
        }
        updateReportIndex();
      } catch {}
    }

    function createReportCardDOM(title, bodyHtml, timeStr, ts, expanded) {
      const reportList = document.getElementById('report-list');
      const header = document.getElementById('report-list-header');
      header.style.display = '';

      const id = `report-${++reportCounter}`;
      const card = document.createElement('div');
      card.className = expanded ? 'report-card expanded' : 'report-card';
      card.id = id;
      card.dataset.ts = ts || Date.now();
      card.dataset.title = title;
      card.innerHTML = `
        <div class="report-card-header">
          <span class="report-card-toggle">&#9654;</span>
          <span class="report-card-title">${escapeHtml(title)}</span>
          <span class="report-card-time">${escapeHtml(timeStr)}</span>
        </div>
        <div class="report-card-body agent-response visible">
          ${bodyHtml}
        </div>
        <div class="report-card-actions">
          <button class="report-action-btn" data-action="download-md">MD</button>
          <button class="report-action-btn" data-action="download-pdf">PDF</button>
          <button class="report-action-btn" data-action="regenerate">Regenerate</button>
          <button class="report-action-btn report-delete-btn" data-action="delete">Delete</button>
        </div>
      `;

      card.querySelector('.report-card-header').addEventListener('click', () => {
        card.classList.toggle('expanded');
      });

      // Download handlers
      card.querySelector('[data-action="download-md"]').addEventListener('click', (e) => {
        e.stopPropagation();
        downloadReportMarkdown(card);
      });
      card.querySelector('[data-action="download-pdf"]').addEventListener('click', (e) => {
        e.stopPropagation();
        downloadReportPdf(card);
      });

      // Regenerate: re-run the query and replace card content
      card.querySelector('[data-action="regenerate"]').addEventListener('click', async (e) => {
        e.stopPropagation();
        const query = card.dataset.title;
        const body = card.querySelector('.report-card-body');
        body.innerHTML = '<div class="loading visible">Regenerating...</div>';
        card.classList.add('expanded');
        try {
          const prompt = query === 'Latest Insights Report'
            ? 'Get the latest insights report and present it in a clear, organized way. Highlight the most important improvement suggestions.'
            : `Analyze my Claude Code usage to answer: ${query}. Use get_dashboard_stats and get_insights_report tools as needed.`;
          const response = await streamAgent(prompt);
          const costHtml = response.cost ? `<div class="cost-display">Agent cost: $${response.cost.toFixed(4)} (${response.turns} turns)</div>` : '';
          body.innerHTML = renderMarkdown(response.text) + costHtml;
          body.classList.add('visible');
          card.querySelector('.report-card-time').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          card.dataset.ts = Date.now();
          saveReportsToStorage();
        } catch (err) {
          body.innerHTML = `<p style="color:red;">Error: ${escapeHtml(String(err))}</p>`;
        }
      });

      // Delete: remove card and update storage
      card.querySelector('[data-action="delete"]').addEventListener('click', (e) => {
        e.stopPropagation();
        card.remove();
        saveReportsToStorage();
        updateReportIndex();
        // Hide header if no cards left
        if (document.querySelectorAll('.report-card').length === 0) {
          document.getElementById('report-list-header').style.display = 'none';
        }
      });

      reportList.prepend(card);
      return card;
    }

    // Convert HTML report body back to approximate markdown
    function htmlToMarkdown(html) {
      let md = html;
      // Strip cost display
      md = md.replace(/<div class="cost-display">[\s\S]*?<\/div>/g, '');
      // Headings
      md = md.replace(/<h1>(.*?)<\/h1>/g, '# $1\n\n');
      md = md.replace(/<h2>(.*?)<\/h2>/g, '## $1\n\n');
      md = md.replace(/<h3>(.*?)<\/h3>/g, '### $1\n\n');
      md = md.replace(/<h4>(.*?)<\/h4>/g, '#### $1\n\n');
      // Bold/italic
      md = md.replace(/<strong>(.*?)<\/strong>/g, '**$1**');
      md = md.replace(/<em>(.*?)<\/em>/g, '*$1*');
      // Code
      md = md.replace(/<code>(.*?)<\/code>/g, '`$1`');
      md = md.replace(/<pre>`([\s\S]*?)`<\/pre>/g, '```\n$1\n```\n\n');
      md = md.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g, '```\n$1\n```\n\n');
      // Lists
      md = md.replace(/<ul>([\s\S]*?)<\/ul>/g, (_, items) =>
        items.replace(/<li>(.*?)<\/li>/g, '- $1\n') + '\n');
      md = md.replace(/<ol>([\s\S]*?)<\/ol>/g, (_, items) => {
        let i = 0;
        return items.replace(/<li>(.*?)<\/li>/g, () => `${++i}. ` + '$1\n') + '\n';
      });
      // Paragraphs and breaks
      md = md.replace(/<br\s*\/?>/g, '\n');
      md = md.replace(/<p>([\s\S]*?)<\/p>/g, '$1\n\n');
      md = md.replace(/<hr\s*\/?>/g, '---\n\n');
      // Tables (keep as-is, strip tags)
      md = md.replace(/<\/?table>/g, '');
      md = md.replace(/<\/?thead>/g, '');
      md = md.replace(/<\/?tbody>/g, '');
      md = md.replace(/<tr>([\s\S]*?)<\/tr>/g, (_, cells) => {
        const cols = [];
        cells.replace(/<t[hd]>(.*?)<\/t[hd]>/g, (__, c) => cols.push(c));
        return '| ' + cols.join(' | ') + ' |\n';
      });
      // Unescape HTML entities
      md = md.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"');
      // Clean up
      md = md.replace(/<[^>]+>/g, ''); // strip remaining tags
      md = md.replace(/\n{3,}/g, '\n\n').trim();
      return md;
    }

    function downloadReportMarkdown(card) {
      const title = card.dataset.title || 'report';
      const body = card.querySelector('.report-card-body').innerHTML;
      const md = `# ${title}\n\n${htmlToMarkdown(body)}`;
      const blob = new Blob([md], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${title.replace(/[^a-zA-Z0-9]+/g, '-').slice(0, 50)}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadReportPdf(card) {
      const title = card.dataset.title || 'report';
      const body = card.querySelector('.report-card-body').innerHTML;
      // Use browser print to PDF via a new window
      const win = window.open('', '_blank');
      win.document.write(`<!DOCTYPE html><html><head>
        <title>${escapeHtml(title)}</title>
        <style>
          body { font-family: Georgia, serif; max-width: 700px; margin: 40px auto; padding: 0 20px; font-size: 14px; line-height: 1.7; color: #111; }
          h1, h2, h3, h4 { font-family: Helvetica Neue, sans-serif; }
          h1 { font-size: 22px; border-bottom: 1px solid #ddd; padding-bottom: 8px; }
          h2 { font-size: 17px; margin-top: 24px; }
          code { background: #f5f5f5; padding: 1px 4px; font-size: 12px; }
          pre { background: #f5f5f5; padding: 12px; overflow-x: auto; font-size: 12px; }
          table { border-collapse: collapse; width: 100%; margin: 16px 0; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
          th { background: #f5f5f5; font-weight: 600; }
          ul, ol { padding-left: 20px; }
        </style>
      </head><body>
        <h1>${escapeHtml(title)}</h1>
        ${body}
        <script>setTimeout(()=>{window.print();window.close()},300)<\/script>
      </body></html>`);
      win.document.close();
    }

    // --- Flashcard review mode ---
    let flashcardIndex = 0;
    let flashcardItems = [];
    let flashcardAnimating = false;

    document.getElementById('report-review-btn').addEventListener('click', openFlashcards);
    document.getElementById('flashcard-close').addEventListener('click', closeFlashcards);
    document.getElementById('flashcard-prev').addEventListener('click', () => navigateFlashcard(-1));
    document.getElementById('flashcard-next').addEventListener('click', () => navigateFlashcard(1));
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('flashcard-overlay').classList.contains('visible')) return;
      if (e.key === 'ArrowLeft') navigateFlashcard(-1);
      if (e.key === 'ArrowRight') navigateFlashcard(1);
      if (e.key === 'Escape') closeFlashcards();
    });
    // Click overlay background to close
    document.getElementById('flashcard-overlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeFlashcards();
    });

    let flashcardTriggerEl = null; // store focus return target

    function openFlashcards() {
      const cards = document.querySelectorAll('.report-card');
      if (cards.length === 0) return;
      flashcardItems = [...cards].map(card => ({
        title: card.dataset.title || card.querySelector('.report-card-title').textContent,
        html: card.querySelector('.report-card-body').innerHTML,
      }));
      flashcardIndex = 0;
      flashcardTriggerEl = document.activeElement;
      renderFlashcard();
      const overlay = document.getElementById('flashcard-overlay');
      overlay.classList.add('visible');
      overlay.setAttribute('aria-modal', 'true');
      document.body.style.overflow = 'hidden'; // prevent background scroll
      document.getElementById('flashcard-close').focus();
    }

    function closeFlashcards() {
      const overlay = document.getElementById('flashcard-overlay');
      overlay.classList.remove('visible');
      overlay.removeAttribute('aria-modal');
      document.body.style.overflow = '';
      if (flashcardTriggerEl) { flashcardTriggerEl.focus(); flashcardTriggerEl = null; }
    }

    function navigateFlashcard(dir) {
      if (flashcardAnimating) return;
      const newIndex = flashcardIndex + dir;
      if (newIndex < 0 || newIndex >= flashcardItems.length) return;

      // Skip animation if user prefers reduced motion
      if (prefersReducedMotion) {
        flashcardIndex = newIndex;
        renderFlashcard();
        return;
      }

      const body = document.getElementById('flashcard-body');
      const slideOutClass = dir > 0 ? 'slide-out-left' : 'slide-out-right';
      const slideInClass = dir > 0 ? 'slide-in-left' : 'slide-in-right';

      flashcardAnimating = true;
      body.classList.add(slideOutClass);

      setTimeout(() => {
        flashcardIndex = newIndex;
        body.classList.remove(slideOutClass);
        body.className = 'flashcard-body agent-response visible ' + slideInClass;
        renderFlashcard(true);
        setTimeout(() => {
          body.classList.remove(slideInClass);
          flashcardAnimating = false;
        }, 260);
      }, 200);
    }

    function renderFlashcard(skipBodyClass) {
      const item = flashcardItems[flashcardIndex];
      if (!item) return;
      document.getElementById('flashcard-counter').textContent = `${flashcardIndex + 1}/${flashcardItems.length}`;
      document.getElementById('flashcard-title').textContent = item.title;
      document.getElementById('flashcard-body').innerHTML = item.html;
      document.getElementById('flashcard-prev').disabled = flashcardIndex === 0;
      document.getElementById('flashcard-next').disabled = flashcardIndex === flashcardItems.length - 1;
      // Progress bar
      const pct = flashcardItems.length > 1 ? ((flashcardIndex + 1) / flashcardItems.length * 100) : 100;
      document.getElementById('flashcard-progress').style.width = pct + '%';
      // Dots (max 10 shown, otherwise just counter)
      const dotsEl = document.getElementById('flashcard-dots');
      if (flashcardItems.length <= 10) {
        dotsEl.innerHTML = flashcardItems.map((_, i) =>
          `<span class="flashcard-dot${i === flashcardIndex ? ' active' : ''}"></span>`
        ).join('');
      } else {
        dotsEl.innerHTML = '';
      }
    }

    function addReportCard(title, contentHtml, costInfo) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const bodyHtml = contentHtml + (costInfo ? `<div class="cost-display">Agent cost: $${costInfo.cost.toFixed(4)} (${costInfo.turns} turns)</div>` : '');

      const card = createReportCardDOM(title, bodyHtml, timeStr, Date.now(), true);

      updateReportIndex();
      saveReportsToStorage();

      card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function updateReportIndex() {
      const indexContainer = document.getElementById('report-index');
      const indexList = document.getElementById('report-index-list');
      const cards = document.querySelectorAll('.report-card');

      if (cards.length === 0) {
        indexContainer.style.display = 'none';
        return;
      }

      indexContainer.style.display = '';
      indexList.innerHTML = '';

      cards.forEach(card => {
        const title = card.querySelector('.report-card-title').textContent;
        const time = card.querySelector('.report-card-time').textContent;
        const btn = document.createElement('button');
        btn.className = 'report-index-item';
        btn.textContent = `${time} - ${title}`;
        btn.addEventListener('click', () => {
          switchView('insights');
          card.classList.add('expanded');
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        indexList.appendChild(btn);
      });
    }

    // Clear all reports
    document.getElementById('report-clear-btn').addEventListener('click', () => {
      document.getElementById('report-list').innerHTML = '';
      document.getElementById('report-list-header').style.display = 'none';
      document.getElementById('report-index').style.display = 'none';
      document.getElementById('report-index-list').innerHTML = '';
      try { localStorage.removeItem(REPORTS_KEY); } catch {}
    });

    // Load persisted reports on startup
    loadReportsFromStorage();

    async function loadInsightsReport() {
      const loading = document.getElementById('insights-loading');
      loading.classList.add('visible');

      try {
        const response = await streamAgent(
          'Get the latest insights report and present it in a clear, organized way. Highlight the most important improvement suggestions.'
        );
        loading.classList.remove('visible');
        addReportCard('Latest Insights Report', renderMarkdown(response.text), response.cost ? response : null);
      } catch (e) {
        loading.classList.remove('visible');
        addReportCard('Latest Insights Report', `<p style="color:red;">Error: ${escapeHtml(String(e))}</p>`, null);
      }
    }

    async function askInsightsAgent() {
      const input = document.getElementById('insights-input');
      const query = input.value.trim();
      if (!query) return;
      const btn = document.getElementById('insights-ask-btn');
      btn.disabled = true;

      const loading = document.getElementById('insights-loading');
      const loadingText = document.getElementById('insights-loading-text');
      loadingText.textContent = `Analyzing: "${query.slice(0, 60)}${query.length > 60 ? '...' : ''}"`;
      loading.classList.add('visible');

      try {
        const response = await streamAgent(
          `Analyze my Claude Code usage to answer: ${query}. Use get_dashboard_stats and get_insights_report tools as needed.`
        );
        loading.classList.remove('visible');
        addReportCard(query, renderMarkdown(response.text), response.cost ? response : null);
      } catch (e) {
        loading.classList.remove('visible');
        addReportCard(query, `<p style="color:red;">Error: ${escapeHtml(String(e))}</p>`, null);
      }
      btn.disabled = false;
    }

    // --- SSE Agent Stream ---
    async function streamAgent(promptText, onEvent) {
      return new Promise((resolve, reject) => {
        let fullText = '';
        let result = {};
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 180000); // 3 min timeout

        fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: promptText }),
          signal: controller.signal,
        }).then(response => {
          if (!response.ok) {
            clearTimeout(timeout);
            reject(new Error(`Server error: ${response.status}`));
            return;
          }
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          function read() {
            reader.read().then(({ done, value }) => {
              if (done) {
                clearTimeout(timeout);
                resolve({ text: fullText, ...result });
                return;
              }

              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || '';

              for (const line of lines) {
                if (!line.startsWith('data: ')) continue;
                const data = line.slice(6);
                if (data === '[DONE]') {
                  clearTimeout(timeout);
                  resolve({ text: fullText, ...result });
                  return;
                }

                try {
                  const event = JSON.parse(data);
                  if (event.type === 'text') {
                    fullText += event.content;
                  } else if (event.type === 'result') {
                    result = { cost: event.cost, turns: event.turns };
                  } else if (event.type === 'error') {
                    reject(new Error(event.message));
                    return;
                  }
                  if (onEvent) onEvent(event);
                } catch {}
              }

              read();
            }).catch(reject);
          }
          read();
        }).catch(reject);
      });
    }

    // --- Markdown Renderer (with tables, lists, paragraphs) ---
    function renderMarkdown(text) {
      if (!text) return '';

      // First extract code blocks so they don't get processed
      const codeBlocks = [];
      text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
        codeBlocks.push(`<pre><code>${escapeHtml(code)}</code></pre>`);
        return `\x00CB${codeBlocks.length - 1}\x00`;
      });

      // Ensure headings always have a blank line before them
      // Handles cases like "some text.## Heading" or "text\n## Heading"
      // [^\n#] avoids splitting multi-hash headings (## shouldn't become # + #)
      text = text.replace(/([^\n#])(#{1,6} )/g, '$1\n\n$2');
      text = text.replace(/\n(#{1,6} )/g, '\n\n$1');

      // Split into blocks by double newline
      const blocks = text.split(/\n\n+/);
      const html = [];

      for (const block of blocks) {
        const trimmed = block.trim();
        if (!trimmed) continue;

        // Check for code block placeholder
        const cbMatch = trimmed.match(/^\x00CB(\d+)\x00$/);
        if (cbMatch) {
          html.push(codeBlocks[parseInt(cbMatch[1])]);
          continue;
        }

        // Skip bare heading markers (# ## ### etc. with no text)
        if (/^#{1,6}\s*$/.test(trimmed)) continue;

        // Heading (h1-h6) -- if block starts with heading, render it
        // and any trailing content as a paragraph
        const headingMatch = trimmed.match(/^(#{1,6}) (.+)$/m);
        if (headingMatch) {
          const level = Math.min(headingMatch[1].length, 4); // cap at h4 for styling
          const tag = `h${level}`;
          html.push(`<${tag}>${inlineFormat(headingMatch[2])}</${tag}>`);
          const afterHeading = trimmed.slice(headingMatch[0].length).trim();
          if (afterHeading) {
            html.push(`<p>${inlineFormat(afterHeading.replace(/\n/g, '<br>'))}</p>`);
          }
          continue;
        }

        // Horizontal rule
        if (/^---+$/.test(trimmed)) { html.push('<hr>'); continue; }

        // Table: detect by separator row |---|---|
        const lines = trimmed.split('\n');
        if (lines.length >= 2 && /^\|[\s-:|]+\|$/.test(lines[1]?.trim())) {
          html.push(renderTable(lines));
          continue;
        }

        // Unordered list
        if (/^[-*] /.test(trimmed)) {
          const items = trimmed.split('\n')
            .filter(l => /^[-*] /.test(l.trim()))
            .map(l => `<li>${inlineFormat(l.trim().replace(/^[-*] /, ''))}</li>`);
          html.push(`<ul>${items.join('')}</ul>`);
          continue;
        }

        // Ordered list
        if (/^\d+\. /.test(trimmed)) {
          const items = trimmed.split('\n')
            .filter(l => /^\d+\. /.test(l.trim()))
            .map(l => `<li>${inlineFormat(l.trim().replace(/^\d+\. /, ''))}</li>`);
          html.push(`<ol>${items.join('')}</ol>`);
          continue;
        }

        // Default: paragraph
        html.push(`<p>${inlineFormat(trimmed.replace(/\n/g, '<br>'))}</p>`);
      }

      // Replace any remaining code block placeholders that weren't standalone blocks
      let result = html.join('\n');
      result = result.replace(/\x00CB(\d+)\x00/g, (_, idx) => codeBlocks[parseInt(idx)] || '');
      return result;
    }

    function inlineFormat(text) {
      return escapeHtml(text)
        .replace(/&lt;br\s*\/?&gt;/g, '<br>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>');
    }

    function renderTable(lines) {
      const parseRow = line =>
        line.trim().replace(/^\|/, '').replace(/\|$/, '').split('|').map(c => c.trim());

      const headers = parseRow(lines[0]);
      // lines[1] is the separator row, skip it
      const rows = lines.slice(2)
        .filter(l => l.trim().startsWith('|'))
        .map(parseRow);

      let html = '<table><thead><tr>';
      for (const h of headers) html += `<th>${inlineFormat(h)}</th>`;
      html += '</tr></thead><tbody>';
      for (const row of rows) {
        html += '<tr>';
        for (let i = 0; i < headers.length; i++) {
          html += `<td>${inlineFormat(row[i] || '')}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      return html;
    }

    // --- Actionable Insights ---

    document.getElementById('generate-actions-btn').addEventListener('click', generateActions);

    async function generateActions() {
      const btn = document.getElementById('generate-actions-btn');
      const loading = document.getElementById('insights-loading');
      const cardsEl = document.getElementById('action-cards');

      btn.disabled = true;
      btn.textContent = 'Analyzing...';
      const loadingText = document.getElementById('insights-loading-text');
      loadingText.textContent = 'Reading session data and generating actionable improvements...';
      loading.classList.add('visible');
      cardsEl.innerHTML = '';

      // Animate loading steps
      const steps = [
        'Reading session statistics...',
        'Analyzing tool usage patterns...',
        'Detecting error patterns...',
        'Generating improvement suggestions...',
      ];
      let stepIdx = 0;
      const stepTimer = setInterval(() => {
        stepIdx = (stepIdx + 1) % steps.length;
        loadingText.textContent = steps[stepIdx];
      }, 3000);

      try {
        const res = await safeFetch('/api/actions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
          timeout: 120000,
        });
        const data = await res.json();

        clearInterval(stepTimer);
        loading.classList.remove('visible');

        if (data.error) {
          addReportCard('Generate Actions', `<p style="color:red;">Error: ${escapeHtml(data.error)}</p>`, null);
          return;
        }

        if (data.actions && data.actions.length > 0) {
          renderActionCards(data.actions);
        } else {
          addReportCard('Generate Actions', '<p>No actionable insights generated.</p>', null);
        }
      } catch (e) {
        loading.classList.remove('visible');
        addReportCard('Generate Actions', `<p style="color:red;">Error: ${escapeHtml(String(e))}</p>`, null);
      } finally {
        clearInterval(stepTimer);
        btn.disabled = false;
        btn.textContent = 'Generate Actions';
      }
    }

    // Store action artifacts by ID for safe retrieval (avoids inline JSON in HTML)
    const actionArtifacts = new Map();

    function renderActionCards(actions, targetContainer) {
      const container = targetContainer || document.getElementById('action-cards');
      actionArtifacts.clear();
      const fragment = document.createDocumentFragment();

      for (let i = 0; i < actions.length; i++) {
        const action = actions[i];
        const actionId = action.id || `action-${i}`;
        const cat = action.category || 'workflow';
        const effort = action.effort || 'medium';
        const hasArtifact = action.artifact && action.artifact.type !== 'info' && action.artifact.content;

        if (hasArtifact) {
          actionArtifacts.set(actionId, action.artifact);
        }

        const card = document.createElement('div');
        card.className = 'action-card';
        card.dataset.actionId = actionId;

        let inner = `<div class="action-card-header">
            <span class="action-category ${escapeHtml(cat)}">${escapeHtml(cat)}</span>
            <span class="action-effort">${escapeHtml(effort)} effort</span>
          </div>
          <div class="action-title">${escapeHtml(action.title || '')}</div>
          <div class="action-observation">${escapeHtml(action.observation || '')}</div>
          <div class="action-description">${escapeHtml(action.description || '')}</div>`;

        if (hasArtifact) {
          inner += `<div class="action-artifact-path">${escapeHtml(action.artifact.path || '')}</div>
            <div class="action-artifact">${escapeHtml(action.artifact.content)}</div>
            <div class="action-buttons">
              <button class="action-btn copy-btn" data-action-id="${escapeHtml(actionId)}">Copy</button>
              <button class="action-btn primary apply-btn" data-action-id="${escapeHtml(actionId)}">Apply</button>
            </div>`;
        }

        card.innerHTML = inner;
        fragment.appendChild(card);
      }

      container.innerHTML = '';
      container.appendChild(fragment);

      // Bind buttons
      container.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const artifact = actionArtifacts.get(btn.dataset.actionId);
          if (!artifact) return;
          navigator.clipboard.writeText(artifact.content).then(() => {
            btn.textContent = 'Copied';
            setTimeout(() => btn.textContent = 'Copy', 1500);
          });
        });
      });

      container.querySelectorAll('.apply-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const artifact = actionArtifacts.get(btn.dataset.actionId);
          if (!artifact) return;
          btn.disabled = true;
          btn.textContent = 'Applying...';

          try {
            const res = await safeFetch('/api/apply-action', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ artifact }),
              timeout: 60000,
            });
            const data = await res.json();

            if (data.success) {
              const buttonsDiv = btn.parentElement;
              buttonsDiv.innerHTML = '';
              const span = document.createElement('span');
              span.className = 'action-applied';
              span.textContent = `Applied -- ${data.action} ${data.path}`;
              buttonsDiv.appendChild(span);
            } else {
              btn.textContent = 'Failed';
              btn.title = data.error || 'Unknown error';
              setTimeout(() => { btn.textContent = 'Apply'; btn.disabled = false; }, 2000);
            }
          } catch (e) {
            btn.textContent = 'Error';
            setTimeout(() => { btn.textContent = 'Apply'; btn.disabled = false; }, 2000);
          }
        });
      });
    }

    // --- Voice Control ---
    const voiceState = { active: false, recognition: null };

    // Context-aware system prompt -- includes current screen & available presets
    function buildVoicePrompt() {
      const currentView = document.querySelector('.nav-tab.active')?.dataset?.view || 'overview';
      const presetNames = [...document.querySelectorAll('.insight-preset')].map(b => b.textContent).join(', ');
      return `You are a voice controller for a Session Explorer dashboard. The user is on the "${currentView}" tab.
Parse the spoken command into JSON. Return ONLY valid JSON.
Actions:
{"action":"filter_project","params":{"project":"name"}}
{"action":"filter_class","params":{"class":"large|medium|quick|strategic|tactical|mechanical|coding|research|errors|interactive"}}
{"action":"clear_filters","params":{}}
{"action":"open_session","params":{"query":"description"}}
{"action":"search","params":{"query":"terms"}}
{"action":"generate_actions","params":{}} -- generates actionable improvement cards
{"action":"ask_insight","params":{"query":"question about usage"}} -- asks the insights agent a question
{"action":"show_errors","params":{}}
{"action":"navigate","params":{"tab":"overview|search|session|insights"}}
{"action":"show_stats","params":{}}
Available insight presets: ${presetNames}
If the user says a preset name (like "tool usage audit" or "error patterns"), use ask_insight with the matching preset's full question.
If the user says "generate insights" or "generate actions", use generate_actions.
If the user asks a QUESTION or requests specific analysis about their sessions, usage, patterns, costs, longest/shortest/most/least anything -- use ask_insight. This includes requests like "longest sessions", "most expensive projects", "what did I work on yesterday", etc.
Only use show_stats if the user explicitly says "show stats" or "go to overview/dashboard".
Only use navigate if the user explicitly asks to switch tabs.
If uncertain between ask_insight and other actions, prefer ask_insight.`;
    }

    const voiceActions = {
      filter_project: (params) => {
        const proj = params.project?.toLowerCase();
        if (!proj) return 'No project specified';
        const match = state.smartFilters.find(f =>
          f.key.startsWith('project:') && f.key.toLowerCase().includes(proj)
        );
        if (match) {
          state.activeFilters.add(match.key);
          renderSmartFilters();
          applyFiltersAndRender();
          return `Filtered: ${match.label}`;
        }
        return `Project "${proj}" not found`;
      },
      filter_class: (params) => {
        const cls = params.class;
        if (!cls) return 'No class specified';
        state.activeFilters.add(`class:${cls}`);
        renderSmartFilters();
        applyFiltersAndRender();
        return `Filtered: ${cls}`;
      },
      clear_filters: () => {
        state.activeFilters.clear();
        state.findQuery = '';
        document.getElementById('find-input').value = '';
        renderSmartFilters();
        applyFiltersAndRender();
        return 'Filters cleared';
      },
      search: (params) => {
        switchView('search');
        document.getElementById('search-input').value = params.query || '';
        doSearch();
        return `Searching: ${params.query}`;
      },
      open_session: (params) => {
        const q = (params.query || '').toLowerCase();
        const match = state.allSessions.find(s =>
          (s.summary || '').toLowerCase().includes(q) ||
          (s.first_prompt || '').toLowerCase().includes(q)
        );
        if (match) { openSession(match.session_id); return `Opened session`; }
        return 'No matching session';
      },
      generate_actions: () => {
        switchView('insights');
        generateActions();
        return 'Generating actions...';
      },
      ask_insight: (params) => {
        const q = params.query || '';
        if (!q) return 'No question specified';
        // Check if it matches a preset
        const presetBtn = [...document.querySelectorAll('.insight-preset')].find(b =>
          b.textContent.toLowerCase().includes(q.toLowerCase().split(' ')[0])
        );
        switchView('insights');
        document.getElementById('insights-input').value = presetBtn ? presetBtn.dataset.q : q;
        askInsightsAgent();
        return `Analyzing: ${q.slice(0, 40)}`;
      },
      show_errors: () => {
        state.activeFilters.add('class:errors');
        renderSmartFilters();
        applyFiltersAndRender();
        return 'Showing error sessions';
      },
      navigate: (params) => {
        switchView(params.tab || 'overview');
        return `Navigated to ${params.tab}`;
      },
      show_stats: () => {
        switchView('overview');
        return 'Showing stats';
      },
    };

    // Voice UI elements (compact tooltip)
    const voiceBtn = document.getElementById('voice-btn');
    const voiceTooltip = document.getElementById('voice-tooltip');
    const voiceTooltipStatus = document.getElementById('voice-tooltip-status');
    const voiceTooltipText = document.getElementById('voice-tooltip-text');
    const voiceMiniWave = document.getElementById('voice-mini-wave');
    const voiceTooltipResult = document.getElementById('voice-tooltip-result');
    const voiceTooltipHint = document.getElementById('voice-tooltip-hint');

    voiceBtn.addEventListener('click', () => {
      // Always (re)start listening on click -- even if stopped or idle
      if (voiceState.recognition) {
        voiceState.recognition.abort();
        voiceState.recognition = null;
      }
      startVoice();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') stopVoice();
    });

    function startVoice() {
      voiceState.active = true;
      voiceBtn.className = 'voice-fab listening';
      voiceTooltip.classList.add('visible');
      voiceMiniWave.classList.add('active');
      voiceTooltipStatus.textContent = 'Listening';
      voiceTooltipText.textContent = 'Speak a command...';
      voiceTooltipText.className = 'voice-tooltip-text dim';
      voiceTooltipResult.style.display = 'none';
      voiceTooltipHint.style.display = 'none';

      try {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
          voiceTooltipStatus.textContent = 'Not supported';
          voiceBtn.className = 'voice-fab idle';
          return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = 0; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          voiceTooltipText.textContent = transcript;
          voiceTooltipText.className = 'voice-tooltip-text';

          if (event.results[0].isFinal) {
            processVoiceCommand(transcript);
          }
        };

        recognition.onerror = (event) => {
          voiceTooltipStatus.textContent = event.error === 'no-speech' ? 'No speech detected' : `Error: ${event.error}`;
          voiceBtn.className = 'voice-fab stopped';
          voiceMiniWave.classList.remove('active');
          voiceTooltipHint.textContent = 'Click mic to try again';
          voiceTooltipHint.style.display = '';
        };

        recognition.onend = () => {
          if (voiceBtn.className.includes('listening')) {
            voiceTooltipStatus.textContent = 'Stopped';
            voiceBtn.className = 'voice-fab stopped';
            voiceMiniWave.classList.remove('active');
          }
        };

        recognition.start();
        voiceState.recognition = recognition;
      } catch (e) {
        voiceTooltipStatus.textContent = `Error: ${e.message}`;
        voiceBtn.className = 'voice-fab stopped';
      }
    }

    function stopVoice() {
      voiceState.active = false;
      voiceBtn.className = 'voice-fab idle';
      voiceTooltip.classList.remove('visible');
      voiceMiniWave.classList.remove('active');
      if (voiceState.recognition) {
        voiceState.recognition.abort();
        voiceState.recognition = null;
      }
    }

    async function processVoiceCommand(transcript) {
      voiceBtn.className = 'voice-fab processing';
      voiceMiniWave.classList.remove('active');
      voiceTooltipStatus.textContent = 'Processing...';

      try {
        const response = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: `${buildVoicePrompt()}\n\nUser said: "${transcript}"` }),
        });

        if (!response.ok) throw new Error(`Server error: ${response.status}`);

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '', fullText = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';
          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const data = line.slice(6);
            if (data === '[DONE]') break;
            try {
              const event = JSON.parse(data);
              if (event.type === 'text') fullText += event.content;
            } catch {}
          }
        }

        const jsonMatch = fullText.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          let action;
          try { action = JSON.parse(jsonMatch[0]); } catch { action = null; }
          if (!action || !action.action) {
            voiceTooltipStatus.textContent = 'Could not parse command';
            voiceBtn.className = 'voice-fab stopped';
            return;
          }
          const handler = voiceActions[action.action];
          if (handler) {
            const result = handler(action.params || {});
            voiceTooltipStatus.textContent = 'Done';
            voiceTooltipResult.textContent = result;
            voiceTooltipResult.style.display = '';
            voiceTooltipHint.textContent = 'Click mic to speak again';
            voiceTooltipHint.style.display = '';
            // Pulse the target input to show where the text went
            const targetInput = document.getElementById('insights-input');
            if (targetInput && action.action === 'ask_insight') {
              targetInput.classList.remove('input-attention');
              void targetInput.offsetWidth; // force reflow
              targetInput.classList.add('input-attention');
            }
            // Brief speech confirmation
            if ('speechSynthesis' in window) {
              const u = new SpeechSynthesisUtterance(result);
              u.rate = 1.2; u.volume = 0.6;
              speechSynthesis.speak(u);
            }
          } else {
            voiceTooltipStatus.textContent = `Unknown: ${action.action}`;
            voiceTooltipHint.textContent = 'Click mic to try again';
            voiceTooltipHint.style.display = '';
          }
        } else {
          voiceTooltipStatus.textContent = 'Could not parse';
          voiceTooltipHint.textContent = 'Click mic to try again';
          voiceTooltipHint.style.display = '';
        }
      } catch (e) {
        voiceTooltipStatus.textContent = `Error`;
        voiceTooltipHint.textContent = 'Click mic to try again';
        voiceTooltipHint.style.display = '';
      }

      voiceBtn.className = 'voice-fab stopped';

      // Auto-hide tooltip after 4s
      setTimeout(() => {
        if (!voiceState.active) voiceTooltip.classList.remove('visible');
      }, 4000);
    }

    // --- Quick action buttons ---
    document.querySelectorAll('.quick-action-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const query = btn.dataset.insightQuery;
        if (query) {
          switchView('insights');
          document.getElementById('insights-input').value = query;
          askInsightsAgent();
        }
      });
    });

    // --- Init ---
    document.getElementById('footer-date').textContent = new Date().toLocaleDateString('en-US', {
      year: 'numeric', month: 'short', day: 'numeric'
    });

    async function initApp() {
      // Restore URL state before loading data
      restoreFromHash();

      await Promise.all([loadStats(), loadSessions()]);

      // Post-load visualizations
      if (state.stats && state.allSessions.length > 0) {
        computeQuickInsights(state.stats, state.allSessions);
        renderSparklines();
        renderSwimlane();
        renderCalendar();
        renderWellbeingStrip();
      }

      // Open pending session from URL hash
      if (state._pendingSessionId) {
        openSession(state._pendingSessionId);
        delete state._pendingSessionId;
      }

      // Re-apply filters from hash
      if (state.activeFilters.size > 0 || state.findQuery) {
        renderSmartFilters();
        applyFiltersAndRender();
      }
    }
    initApp();
  </script>
</body>
</html>
